<html>
<head>
	<title>SVG test</title>
</head>
<body style="overflow: hidden;background-color:rgb(0,0,0)">
	<div style="border:1px solid #000000;width:100%;height:100%" id="viewPort">
		


</div>

<script language="JavaScript">

var Color=function(r,g,b){
	this.r=r;
	this.g=g;
	this.b=b;
	this.toString=function(){
		return "rgb("+this.r+", "+this.g+", "+this.b+")";
	};
};

var threeD={
	Point: function(x, y, z){
		this.x=x;
		this.y=y;
		this.z=z;
	},
	Line: function(point1, point2){
		this.p1=point1;
		this.baseVector=point2.minus(point1);
	},
	Rotation: function(around, axis, angle){
		this.around=around;
		this.axis=axis;
		this.angle=angle;
	},
	OtherRotation: function(around, axisDirection, angle){
		this.around=around;
		this.direction=axisDirection;
		this.angle=angle;
	},
	intersectionOfPlanes: function(p1, n1, p2, n2){
		if(n1.sameDirection(n2)||n1.sameDirection(n2.scale(-1))){return null;}
		var base=n1.cross(n2);
		var p1dn1=p1.dot(n1);
		var p2dn2=p2.dot(n2);
		var x,y,z;
		if(base.x!=0){
			x=0;
			y=(n2.z*p1dn1-n1.z*p2dn2)/base.x;
			z=(-n2.y*p1dn1+n1.y*p2dn2)/base.x;
		}
		else if(base.y!=0){
			x=-(n2.z*p1dn1-n1.z*p2dn2)/base.y;
			y=0;
			z=-(-n2.x*p1dn1+n1.x*p2dn2)/base.y;
		}
		else if(base.z!=0){
			x=(n2.y*p1dn1-n1.y*p2dn2)/base.z;
			y=(-n2.x*p1dn1+n1.x*p2dn2)/base.z;
			z=0;
		}
		var basePoint=new threeD.Point(x, y, z);
		return new this.Line(basePoint, basePoint.plus(base));
	},
	makePointFunctions: function(){
		var self=this;
		this.Point.prototype.plus=function(p){
			return new self.Point(this.x+p.x,this.y+p.y,this.z+p.z);
		};
		this.Point.prototype.scale=function(r){
			return new self.Point(this.x*r, this.y*r, this.z*r);
		};
		this.Point.prototype.minus=function(p){
			return this.plus(p.scale(-1));
		};
		this.Point.prototype.dot=function(p){
			return this.x*p.x+this.y*p.y+this.z*p.z;
		};
		this.Point.prototype.cross=function(p){
			return new self.Point(this.y*p.z-this.z*p.y,this.z*p.x-this.x*p.z,this.x*p.y-this.y*p.x);
		};
		this.Point.prototype.norm=function(){
			return Math.sqrt(Math.pow(this.x, 2)+Math.pow(this.y, 2)+Math.pow(this.z, 2));
		};
		this.Point.prototype.unit=function(){
			if(this.norm()==0){return this;}
			return this.scale(1/this.norm());
		};
		this.Point.prototype.project=function(p){
			var u=this.unit();
			return u.scale(u.dot(p));
		};
		this.Point.prototype.projectOnPlane=function(point, normal){
			return point.plus(this.minus(point).minus(normal.project(this.minus(point))));
		};
		this.Point.prototype.rotate=function(around, axis, angle){
			var op=this.minus(around);
			if(axis==0){
				var npy=op.y*Math.cos(angle)-op.z*Math.sin(angle);
				var npz=op.z*Math.cos(angle)+op.y*Math.sin(angle);
				return around.plus(new self.Point(op.x, npy, npz));
			}
			if(axis==1){
				var npz=op.z*Math.cos(angle)-op.x*Math.sin(angle);
				var npx=op.x*Math.cos(angle)+op.z*Math.sin(angle);
				return around.plus(new self.Point(npx, op.y, npz));
			}
			if(axis==2){
				var npx=op.x*Math.cos(angle)-op.y*Math.sin(angle);
				var npy=op.y*Math.cos(angle)+op.x*Math.sin(angle);
				return around.plus(new self.Point(npx, npy, op.z));
			}
		};
		this.Point.prototype.rotateWithRotation=function(r){
			return this.rotate(r.around, r.axis, r.angle);
		};
		this.Point.prototype.rotateWithOtherRotation=function(r){
			var op=this.minus(r.around);
			var opUnchanged=r.direction.project(op);
			op=op.minus(opUnchanged);
			if(op.norm()>0){
				var yAxis=r.direction.cross(op);
				op=op.scale(Math.cos(r.angle)).plus(yAxis.unit().scale(op.norm()*Math.sin(r.angle)));
				return r.around.plus(opUnchanged).plus(op);
			}else{
				return new self.Point(this.x, this.y, this.z);
			}
		};
		this.Point.prototype.perpendicularTo=function(p){
			return Math.abs(this.dot(p))<0.0005;
		};
		this.Point.prototype.isZero=function(){
			return this.x==0&&this.y==0&&this.z==0;
		};
		this.Point.prototype.sameDirection=function(p){
			return !this.isZero()&&!p.isZero()&&(this.dot(p)==this.norm()*p.norm());
		};
		this.Line.prototype.intersectWithPlane=function(point, normal){
			if(this.baseVector.perpendicularTo(normal)){return null;}
			var t=-normal.dot(this.p1.minus(point))/normal.dot(this.baseVector);
			return this.p1.plus(this.baseVector.scale(t));
		};
		return this;
	},
	makeUnits: function(){
		this.or=new this.Point(0,0,0);
		this.xu=new this.Point(1,0,0);
		this.yu=new this.Point(0,1,0);
		this.zu=new this.Point(0,0,1);
		return this;
	}
}.makePointFunctions().makeUnits();
var twoD={
	setWh: function(w,h){
		this.w=w;
		this.h=h;
		return this.setCorners();
	},
	setCorners: function(){
		this.corners=[this.p(0,0), this.p(0,this.h), this.p(this.w, this.h), this.p(this.w,0)];
		this.ltcorners=[{left:0,top:0},{left:0,top:this.h},{left: this.w, top:this.h},{left:this.w,top:0}];
		return this;
	},
	d: function(lt1, lt2){
		return this.plt(lt1).minus(this.plt(lt2)).norm();
	},
	p: function(x,y){
		return new threeD.Point(x,y,0);
	},
	plt: function(lt){
		return this.p(lt.left, lt.top);
	},
	ltp: function(p){
		return {left:p.x,top:p.y};
	},
	intersectLineSegments: function(p1,p2,p3,p4){
		var a=p2.minus(p1);
		var b=p4.minus(p3);
		var c=p3.minus(p1);
		var d=a.cross(b);
		var nd=d.norm();
		if(nd==0){return null;}
		var i=p1.plus(a.scale(c.cross(b).dot(d)/Math.pow(nd, 2)));
		return this.ltp(i);
	},
	distanceToLine: function(p1, direction, p2){
		var l=p2.minus(p1);
		return l.norm()*l.unit().dot(direction.unit());
	},
	distanceToEdge: function(lt1, lt2){
		var direction=this.plt(lt2).minus(this.plt(lt1));
		var d=0;
		for(var i=0;i<4;i++){
			var dd=this.distanceToLine(this.plt(lt2), direction, this.corners[i]);
			if(dd>=d){d=dd;}
		}
		return d;
	},
	moveToEdge: function(lt1, lt2, w, h){
		var d=this.d(lt1, lt2);
		var d1=this.distanceToEdge(lt1, lt2);
		return {left:lt1.left+(lt2.left-lt1.left)*(1+d1/d),top:lt1.top+(lt2.top-lt1.top)*(1+d1/d)};
	},
	makeInfinite: function(lt1, lt2, hlt){
		var d=this.d(lt1, lt2);
		var nlt1=lt1;
		var nlt2=lt2;
		if(d!=0){
			if(hlt!=null&&((hlt.left<lt1.left&&lt1.left<lt2.left)||(hlt.left>lt1.left&&lt1.left>lt2.left))){
				nlt1=hlt;
			}else{
				var toEdge=this.moveToEdge(lt2, lt1, this.w, this.h);
				nlt1=toEdge;
			}
			if(hlt!=null&&((hlt.left<lt2.left&&lt2.left<lt1.left)||(hlt.left>lt2.left&&lt2.left>lt1.left))){
				nlt2=hlt;
			}else{
				var toEdge=this.moveToEdge(lt1, lt2, this.w, this.h);
				nlt2=toEdge;
			}
		}
		return [nlt1, nlt2];
	},
	completeTheSquare: function(lt1, lt2, lt3){
		var step1=this.plt(lt1);
		var step2=this.plt(lt2);
		var a=step2.minus(step1);
		var b=this.plt(lt3).minus(step1);
		if(a.cross(b).z>0){
			var step3=step2.plus(new threeD.Point(-a.y, a.x, 0));
		}else{
			var step3=step2.plus(new threeD.Point(a.y, -a.x, 0));
		}
		var step4=step3.plus(a.scale(-1));
		return [this.ltp(step3),this.ltp(step4)];
	}
};
var viewPort={
	setWh: function(w,h){
		this.w=w;
		this.h=h;
		return this.setSize();
	},
	leftTop: new threeD.Point(1, 1, -1),
	leftAxis: new threeD.Point(-1,0,0),
	topAxis: new threeD.Point(0,-1,0),
	viewPoint: new threeD.Point(0,0,-3),
	setSize: function(){
		var r=this.h/this.w;
		this.leftTop=new threeD.Point(0.5, 0.5*r,-1);
		this.topAxis=this.topAxis.scale(r);
		this.normal=this.leftAxis.cross(this.topAxis);
		return this;
	},
	setScale: function(r){
		this.leftAxis=this.leftAxis.scale(r);
		this.topAxis=this.topAxis.scale(r);
	},
	horizonLt: function(line){
		var direction=line.baseVector;
		if(direction.perpendicularTo(this.normal)){return null;}
		if(direction.dot(this.normal)<0){direction=direction.scale(-1);}
		return this.lt(this.viewPoint.plus(direction));
	},
	getVisiblePointsOn: function(line){
		if(line.baseVector.perpendicularTo(this.normal)){
			if(line.p1.minus(this.viewPoint).dot(this.normal)>0){return [this.lt(line.p1), this.lt(line.p1.plus(line.baseVector))];}
			else{return [null, null];}
		}
		var p1=line.intersectWithPlane(this.leftTop, this.normal);
		var p2=p1.scale(0.5).plus(line.intersectWithPlane(this.viewPoint, this.normal).scale(0.5));
		return [this.lt(p1),this.lt(p2)];
	},
	getVisiblePointsBetween: function(p1, p2){
		var ltp1=this.lt(p1);
		var ltp2=this.lt(p2);
		if(ltp1==null&&ltp2==null){return [null, null];}
		if(ltp1!=null&&ltp2!=null){return [ltp1, ltp2];}
		var p3=new threeD.Line(p1,p2).intersectWithPlane(this.viewPoint, this.normal);
		if(ltp1==null){
			return [this.lt(p2.plus(p3).scale(0.5)), ltp2];
		}
		if(ltp2==null){
			return [ltp1, this.lt(p1.plus(p3).scale(0.5))];
		}
	},
	lt: function(point){
		var line=new threeD.Line(this.viewPoint, point);
		if(line.baseVector.perpendicularTo(this.normal)){return null;}
		var t=-this.normal.dot(this.viewPoint.minus(this.leftTop))/this.normal.dot(line.baseVector);
		if(t<0){return null;}
		var inPlane=this.viewPoint.plus(line.baseVector.scale(t));
		var leftTopToInPlane=inPlane.minus(this.leftTop);
		var l=this.leftAxis.unit().dot(leftTopToInPlane)/this.leftAxis.norm();
		var t=this.topAxis.unit().dot(leftTopToInPlane)/this.topAxis.norm();
		return {left: l*this.w,top: t*this.h};
	},
	rotateWithOtherRotation: function(r){
		this.leftAxis=this.leftTop.plus(this.leftAxis);
		this.topAxis=this.leftTop.plus(this.topAxis);
		this.leftTop=this.leftTop.rotateWithOtherRotation(r);
		this.leftAxis=this.leftAxis.rotateWithOtherRotation(r).minus(this.leftTop);
		this.topAxis=this.topAxis.rotateWithOtherRotation(r).minus(this.leftTop);
		this.viewPoint=this.viewPoint.rotateWithOtherRotation(r);
		this.normal=this.leftAxis.cross(this.topAxis);
	},
	rotX: function(angle){
		this.rotateWithOtherRotation(new threeD.OtherRotation(threeD.or, this.leftAxis, angle));
	},
	rotY: function(angle){
		this.rotateWithOtherRotation(new threeD.OtherRotation(threeD.or, this.topAxis, angle));
	},
	rotZ: function(angle){
		this.rotateWithOtherRotation(new threeD.OtherRotation(threeD.or, this.leftAxis.cross(this.topAxis), angle));
	},
	scale: function(r){
		this.leftTop=this.leftTop.scale(r);
		this.leftAxis=this.leftAxis.scale(r);
		this.topAxis=this.topAxis.scale(r);
		this.viewPoint=this.viewPoint.scale(r);
		this.normal=this.leftAxis.cross(this.topAxis);
	},
	toString: function(){
		var s='<viewport w="'+this.w+'" h="'+this.h+'">';
		s+='<lefttop x="'+this.leftTop.x+'" y="'+this.leftTop.y+'" z="'+this.leftTop.z+'" />';
		s+='<leftaxis x="'+this.leftAxis.x+'" y="'+this.leftAxis.y+'" z="'+this.leftAxis.z+'" />';
		s+='<topaxis x="'+this.topAxis.x+'" y="'+this.topAxis.y+'" z="'+this.topAxis.z+'" />';
		s+='<viewpoint x="'+this.viewPoint.x+'" y="'+this.viewPoint.y+'" z="'+this.viewPoint.z+'" />';
		s+='</viewport>';
		return s;
	},
};
var LineSegmentFactory={
	lineSegments: [],
	currentNumber: 0,
	LineSegment: function(from, to, id, index){
		this.index=index;
		this.setFromTo=function(from, to){
			this.from=from;
			this.to=to;
		}
		this.draw=function(){
			var visible=viewPort.getVisiblePointsBetween(this.from, this.to);
			var flt=visible[0];
			var tlt=visible[1];
			if(flt==null||tlt==null){
				this.svg.none();
			}else{
				this.svg.setFromTo(flt, tlt);
				this.svg.draw();
			}
		};
		this.setColor=function(color){
			this.svg.setColor(color);
		};
		this.setSvg=function(svg){
			this.svg=svg;
			return this;
		};
		this.setFromTo(from, to);
	},
	makeLineSegment: function(from, to, color){
		var id="lineSegment"+this.currentNumber;
		var index=this.currentNumber;
		var ls=new this.LineSegment(from, to, id, index).setSvg(svg.addLineSegment(0,0,0,0, id, index, color));
		this.lineSegments[this.currentNumber]=ls;
		this.currentNumber++;
		return ls;
	}
};
var LineLineFactory={
	lineLines: [],
	currentNumber: 0,
	LineLine: function(p1, p2, id, index){
		this.index=index;
		this.setFromTo=function(p1,p2){
			this.line=new threeD.Line(p1,p2);
			this.p1=p1;
			this.p2=p2;
		};
		this.draw=function(){
			var visible=viewPort.getVisiblePointsOn(this.line);
			var p1lt=viewPort.lt(this.p1);
			if(p1lt==null){p1lt=visible[0];}
			var p2lt=viewPort.lt(this.p2);
			if(p2lt==null){p2lt=visible[1];}
			var hlt=viewPort.horizonLt(this.line);
			if(p1lt==null&&p2lt==null){
				this.svg.none();
			}else{
				this.svg.setFromTo(p1lt, p2lt);
				this.svg.makeInfinite(hlt);
			}
			this.svg.draw();
		};
		this.setColor=function(color){
			this.svg.setColor(color);
		};
		this.setSvg=function(svg){
			this.svg=svg;
			return this;
		};
		this.setFromTo(p1,p2);
	},
	makeLineLine: function(p1, p2, color, thickness){
		var id="lineLine"+this.currentNumber;
		var index=this.currentNumber;
		//svg.addLineLine(0,0,0,0, id, index, color, thickness);
		var ll=new this.LineLine(p1,p2,id,index).setSvg(svg.addLineLine(0,0,0,0, id, index, color, thickness));
		this.lineLines[this.currentNumber]=ll;
		this.currentNumber++;
		return ll;
	}
};
var PlaneFactory={
	planes: [],
	currentNumber: 0,
	Plane: function(point, normal, id, index, color){
		this.point=point;
		this.normal=normal;
		this.index=index;
		this.color=color;
		this.setAxes=function(){
			if(this.normal.cross(threeD.xu).norm()!=0){
				this.xAxis=this.point.plus(threeD.xu).projectOnPlane(this.point, this.normal).minus(this.point).unit();
			}
			else if(this.normal.cross(threeD.yu).norm()!=0){
				this.xAxis=this.point.plus(threeD.yu).projectOnPlane(this.point, this.normal).minus(this.point).unit();
			}
			else if(this.normal.cross(threeD.zu).norm()!=0){
				this.xAxis=this.point.plus(threeD.zu).projectOnPlane(this.point, this.normal).minus(this.point).unit();
			}
			this.yAxis=this.normal.cross(this.xAxis);
		};
		this.getHorizonLts=function(){
			var horizonDirections=[];
			horizonDirections[0]=this.normal.cross(viewPort.leftAxis);
			horizonDirections[1]=this.normal.cross(horizonDirections[0]);
			horizonDirections[2]=horizonDirections[0].plus(horizonDirections[1]);
			horizonDirections[3]=this.normal.cross(viewPort.topAxis);
			horizonDirections[4]=this.normal.cross(horizonDirections[3]);
			horizonDirections[5]=horizonDirections[3].plus(horizonDirections[4]);
			var nonNullHlt=[];
			var count=0;
			for(var i=0;i<horizonDirections.length;i++){
				var hlt=viewPort.horizonLt(new threeD.Line(this.point, this.point.plus(horizonDirections[i])));
				if(hlt!=null){
					nonNullHlt[count++]=hlt;
				}
				if(count==2){break;}
			}
			return nonNullHlt;
		};
		this.getInPlaneLt=function(){
			var lt;
			var inPlane1=new threeD.Line(viewPort.leftTop, viewPort.leftTop.plus(viewPort.leftAxis)).intersectWithPlane(this.point, this.normal);
			var inPlane2=new threeD.Line(viewPort.leftTop, viewPort.leftTop.plus(viewPort.topAxis)).intersectWithPlane(this.point, this.normal);
			if(inPlane1==null){
				lt=viewPort.lt(inPlane2);
			}else{
				lt=viewPort.lt(inPlane1);
			}
			return lt;
		};
		this.pointWithCoords=function(x,y){
			return this.point.plus(this.xAxis.scale(x)).plus(this.yAxis.scale(y));
		};
		this.getPairwiseGridPoints=function(){
			var gp=[];
			var n=20;
			for(var i=-n;i<=n;i++){
				gp.push([this.pointWithCoords(i,n), this.pointWithCoords(i,-n)]);
				gp.push([this.pointWithCoords(-n,i), this.pointWithCoords(n,i)]);
			}
			return gp;
		};
		this.draw=function(){
			if(this.normal.cross(viewPort.normal).norm()==0){
				if(this.point.minus(viewPort.viewPoint).dot(viewPort.normal)>=0){this.svg.full();}else{this.svg.none();}
				this.svg.draw();
				return;
			}
			var nonNullHlt=this.getHorizonLts();
			this.svg.setHorizonPoints(nonNullHlt[0], nonNullHlt[1], this.getInPlaneLt());
			this.svg.draw();
		};
		this.setColor=function(color){
			this.color=color;
			this.svg.setColor(color);
			for(var i in this.gridLines){this.gridLines[i].setColor(color);}
		}
		this.toString=function(){
			return '<plane reflection="0" diffusion="0.4" color="'+this.color.r+','+this.color.g+','+this.color.b+'">'+
			'<point x="'+this.point.x+'" y="'+this.point.y+'" z="'+this.point.z+'"/>'+
			'<normal x="'+this.normal.x+'" y="'+this.normal.y+'" z="'+this.normal.z+'"/>'+
			'</plane>';
		};
		this.setSvg=function(svg){
			this.svg=svg;
			return this;
		};
		this.getId=function(){
			return id;
		};
		this.makeGrid=function(){
			this.gridLines=[];
			var pairwiseGridPoints=this.getPairwiseGridPoints();
			for(var i in pairwiseGridPoints){
				this.gridLines.push(LineLineFactory.makeLineLine(pairwiseGridPoints[i][0],pairwiseGridPoints[i][1], color, 1));
			}
		};
		this.setAxes();
		this.makeGrid();
	},
	makePlane: function(point, normal, color){
		var id="plane"+this.currentNumber;
		var index=this.currentNumber;
		var p=new this.Plane(point, normal, id, index, color).setSvg(svg.addPlane(0,0,0,0,0,0,0,0,id,index, color));
		this.planes[this.currentNumber]=p;
		this.currentNumber++;
		return p;
	}
};
var SphereFactory={
	spheres: [],
	currentNumber: 0,
	Sphere: function(center, radius, id, index, color){
		this.center=center;
		this.radius=radius;
		this.index=index;
		this.color=color;
		this.draw=function(){
			var toCenter=this.center.minus(viewPort.viewPoint);
			var d=toCenter.norm();
			var r=this.radius;
			if(d<=r){this.svg.none();this.svg.draw();return;}
			var startingPoint=this.center.plus(toCenter.cross(viewPort.leftAxis).unit().scale(d*r/Math.sqrt(d*d-r*r)));
			var pointList=[startingPoint];
			var n=24;
			var rot=new threeD.OtherRotation(viewPort.viewPoint, toCenter, 2*Math.PI/n);
			for(var i=1;i<n;i++){
				startingPoint=startingPoint.rotateWithOtherRotation(rot);
				pointList[pointList.length]=startingPoint;
			}
			var ltList=[];
			for(var i=0;i<pointList.length;i++){
				var lt=viewPort.lt(pointList[i]);
				if(lt!=null){ltList[ltList.length]=lt;}
			}
			this.svg.setPoints(ltList);
			this.svg.draw();
		};
		this.setColor=function(color){
			this.color=color;
			this.svg.setColor(color);
			for(var i in this.gridLineSegments){this.gridLineSegments[i].setColor(color);}
		}
		this.pointWithCoords=function(lo, la){
			return this.center.plus(threeD.xu.rotate(threeD.or, 2, la).rotate(threeD.or, 1, lo).scale(this.radius));
		};
		this.getPairwiseGridPoints=function(){
			var gp=[];
			for(var lo=-Math.PI;lo<=Math.PI;lo+=Math.PI/5){
				var pointsOnMeridian=this.pointsOnMeridian(lo,20);
				for(var i=1;i<pointsOnMeridian.length;i++){
					gp.push([pointsOnMeridian[i-1], pointsOnMeridian[i]]);
				}
			}
			for(var la=-Math.PI/2;la<=Math.PI/2;la+=Math.PI/5){
				var pointsOnLatitude=this.pointsOnLatitude(la, 20);
				for(var i=1;i<pointsOnLatitude.length;i++){
					gp.push([pointsOnLatitude[i-1], pointsOnLatitude[i]]);
				}
			}
			return gp;
		};
		this.pointsOnMeridian=function(lo, n){
			var pointsOnMeridian=[];
			for(var la=-Math.PI/2; la<=Math.PI/2; la+=Math.PI/n){
				pointsOnMeridian[pointsOnMeridian.length]=this.pointWithCoords(lo,la);
			}
			return pointsOnMeridian;
		};
		this.pointsOnLatitude=function(la, n){
			var pointsOnLatitude=[];
			for(var lo=-Math.PI;lo<=Math.PI;lo+=2*Math.PI/n){
				pointsOnLatitude[pointsOnLatitude.length]=this.pointWithCoords(lo,la);
			}
			return pointsOnLatitude;
		};
		this.setSvg=function(svg){
			this.svg=svg;
			return this;
		};
		this.toString=function(){
			var s='<sphere reflection="0" diffusion="0.4" color="'+this.color.r+','+this.color.g+','+this.color.b+'" radius="'+this.radius+'">'+
			'<center x="'+this.center.x+'" y="'+this.center.y+'" z="'+this.center.z+'" />'+
			'</sphere>';
			return s;
		};
		this.getId=function(){
			return id;
		};
		this.makeGrid=function(){
			this.gridLineSegments=[];
			var pairwiseGridPoints=this.getPairwiseGridPoints();
			for(var i in pairwiseGridPoints){
				this.gridLineSegments.push(LineSegmentFactory.makeLineSegment(pairwiseGridPoints[i][0],pairwiseGridPoints[i][1], this.color));
			}
		};
		this.makeGrid();
	},
	makeSphere: function(center, radius, color){
		var id="sphere"+this.currentNumber;
		var index=this.currentNumber;
		var s=new this.Sphere(center, radius, id, index, color).setSvg(svg.addSphere(id, index, color));
		this.spheres[this.currentNumber]=s;
		this.currentNumber++;
		return s;
	}
};
var LightSourceFactory={
	lightSources: [],
	currentNumber: 0,
	LightSource: function(center, radius, id, index, color){
		SphereFactory.Sphere.call(this, center, radius, id,index, color);
		/*this.setSvg=function(index){
			this.svg=svg.lightSources[index];
			return this;
		};*/
		this.toString=function(){
			var s='<lightsource color="'+this.color.r+','+this.color.g+','+this.color.b+'" radius="'+this.radius+'">'+
			'<location x="'+this.center.x+'" y="'+this.center.y+'" z="'+this.center.z+'" />'+
			'</lightsource>';
			return s;
		};
	},
	makeLightSource: function(center, radius, color){
		var id="lightSource"+this.currentNumber;
		var index=this.currentNumber;
		var s=new this.LightSource(center, radius, id, index,color).setSvg(svg.addLightSource(id, index, color));
		this.lightSources[this.currentNumber]=s;
		s.makeGrid();
		this.currentNumber++;
		return s;
	}
};
var drawThings=function(){
	var orlt=viewPort.lt(threeD.or);
	var ult=[viewPort.lt(threeD.xu), viewPort.lt(threeD.yu), viewPort.lt(threeD.zu)];
	var nn=["x","y","z"];
	var n, lt, i;
	for(i=0;i<3;i++){
		n=nn[i];
		lt=ult[i];
		document.getElementById(n+"Axis").setAttribute("x1", orlt.left);
		document.getElementById(n+"Axis").setAttribute("y1", orlt.top);

		document.getElementById(n+"Axis").setAttribute("x2", lt.left);
		document.getElementById(n+"Axis").setAttribute("y2", lt.top);
		
		document.getElementById(n+"AxisLabel").setAttribute("x", lt.left-5);
		document.getElementById(n+"AxisLabel").setAttribute("y", lt.top-5);
	};
	
	var lineSegments=LineSegmentFactory.lineSegments;
	for(i=0;i<lineSegments.length;i++){
		lineSegments[i].draw();
	}
	var lineLines=LineLineFactory.lineLines;
	for(i=0;i<lineLines.length;i++){
		lineLines[i].draw();
	}
	var planes=PlaneFactory.planes;
	for(i=0;i<planes.length;i++){
		planes[i].draw();
	}
	var spheres=SphereFactory.spheres;
	for(i=0;i<spheres.length;i++){
		spheres[i].draw();
	}
	var lightSources=LightSourceFactory.lightSources;
	for(i=0;i<lightSources.length;i++){
		lightSources[i].draw();
	}
};
var SvgSphere=function(id, color){
	document.getElementById("viewPortSvg").innerHTML+="<polygon points='0,0 0,0 0,0' style='fill: "+color.toString()+";fill-opacity: 0.4' id='"+id+"'>";
	this.points=[{left:0,top:0},{left:0,top:0},{left:0,top:0}];
	this.setPoints=function(list){
		this.points=list;
	};
	this.none=function(){this.setPoints([{left:0,top:0},{left:0,top:0},{left:0,top:0}]);}
	this.draw=function(){
		var s="";
		for(i in this.points){s+=this.points[i].left+","+this.points[i].top+" ";}
			document.getElementById(id).setAttribute("points", s);
	};
	this.setColor=function(color1){
		document.getElementById(id).setAttribute('style', 'fill: '+color1.toString()+';fill-opacity: 0.4');
	};
};
var SvgLine=function(l1,t1,l2,t2,id, color, thickness){
	document.getElementById("viewPortSvg").innerHTML+="<line x1='"+l1+"' y1='"+t1+"' x2='"+l2+"' y2='"+t2+"' style='stroke:"+color.toString()+";stroke-width: "+thickness+";stroke-opacity: 1.5' id='"+id+"'>";
	this.lt1={left:l1,top:t1};
	this.lt2={left:l2,top:t2};
	this.setFromTo=function(f,t){this.lt1=f;this.lt2=t;};
	this.draw=function(){
		document.getElementById(id).setAttribute("x1", this.lt1.left);
		document.getElementById(id).setAttribute("y1", this.lt1.top);
		document.getElementById(id).setAttribute("x2", this.lt2.left);
		document.getElementById(id).setAttribute("y2", this.lt2.top);
	};
	this.setColor=function(color1){
		document.getElementById(id).setAttribute('style','stroke:'+color1.toString()+';stroke-width: '+thickness+';stroke-opacity: 1.5');
	};
	this.makeInfinite=function(hlt){
		var nlt=twoD.makeInfinite(this.lt1, this.lt2,hlt);
		this.lt1=nlt[0];
		this.lt2=nlt[1];
		
	};
	this.none=function(){this.setFromTo({left:0,top:0},{left:0,top:0});}
};
var SvgPlane=function(l1, t1, l2, t2, l3, t3, l4, t4, id, color){
	document.getElementById("viewPortSvg").innerHTML+="<polygon points='"+l1+","+t1+" "+l2+","+t2+" "+l3+","+t3+" "+l4+","+t4+"' style='fill: "+color.toString()+";fill-opacity: 0.4' id='"+id+"'>";
	this.lt1={left:l1,top:t1};
	this.lt2={left:l2,top:t2};
	this.lt3={left:l3,top:t3};
	this.lt4={left:l4,top:t4};
	this.setPoints=function(lt1, lt2, lt3, lt4){
		this.lt1=lt1;
		this.lt2=lt2;
		this.lt3=lt3;
		this.lt4=lt4;
	};
	this.full=function(){
		this.setPoints(twoD.ltcorners[0], twoD.ltcorners[1], twoD.ltcorners[2], twoD.ltcorners[3]);
	};
	this.none=function(){this.setPoints({left:0,top:0},{left:0,top:0},{left:0,top:0},{left:0,top:0});};
	
	this.setHorizonPoints=function(lt1, lt2, inPlaneLt){
		var ltlt=twoD.makeInfinite(lt1, lt2, null);
		var otherTwo=twoD.completeTheSquare(ltlt[0], ltlt[1], inPlaneLt);
		this.setPoints(ltlt[0], ltlt[1], otherTwo[0], otherTwo[1]);
		
	};
	this.draw=function(){
		var t=function(x){return x};
		document.getElementById(id).setAttribute("points", t(this.lt1.left)+","+t(this.lt1.top)+" "+t(this.lt2.left)+","+t(this.lt2.top)+" "+t(this.lt3.left)+","+t(this.lt3.top)+" "+t(this.lt4.left)+","+t(this.lt4.top));
	};
	this.setColor=function(color1){
		document.getElementById(id).setAttribute('style', 'fill: '+color1.toString()+';fill-opacity: 0.4');
	};
};
var svg={
	setWh: function(w,h){
		this.w=w;
		this.h=h;
	},
	preventDefault: function(evt){
		evt.preventDefault();
	},
	mouseLocation: {oldl:0,oldt:0,setOldLt: function(l,t){this.oldl=l;this.oldt=t;}},
	lineSegments: [],
	lineLines: [],
	planes: [],
	spheres: [],
	lightSources: [],
	mouseDown: false,
	onMyMouseMove: function(l,t){
		if(this.mouseDown){
			var dl=l-this.mouseLocation.oldl;
			var dt=t-this.mouseLocation.oldt;
			viewPort.rotY(dl/1000);
			viewPort.rotX(-dt/1000);
			drawThings();
			this.mouseLocation.setOldLt(l, t);
		}
	},
	onMyMouseDown: function(l, t){
		this.mouseLocation.setOldLt(l, t);this.mouseDown=true;
	},
	onMyMouseUp: function(){this.mouseDown=false;},
	onMouseDown: function(evt){
		this.preventDefault(evt);
		var l=evt.clientX;
		var t=evt.clientY;
		this.onMyMouseDown(l,t);
	},
	onMouseUp: function(){this.onMyMouseUp();},
	onMouseMove: function(evt){
		this.preventDefault(evt);
		var l=evt.clientX;
		var t=evt.clientY;
		this.onMyMouseMove(l,t);
	},
	onTouchStart: function(evt){
		this.preventDefault(evt);
		var touches=evt.changedTouches;
		if(touches.length==1){
			var touch=evt.changedTouches[0];
			this.onMyMouseDown(touch.clientX, touch.clientY);
		}
	},
	onTouchEnd: function(evt){
		this.onMyMouseUp();
	},
	onTouchMove: function(evt){
		this.preventDefault(evt);
		var touches=evt.changedTouches;
		if(touches.length==1){
			var touch=evt.changedTouches[0];
			this.onMyMouseMove(touch.clientX, touch.clientY);
		}
	},
	addLineSegment: function(l1,t1,l2,t2, id, index, color){
		var s=new SvgLine(l1,t1,l2,t2,id,color, 1);
		this.lineSegments[index]=s;
		return s;
	},
	addLineLine: function(l1,t1,l2,t2,id,index,color, thickness){
		var s=new SvgLine(l1,t1,l2,t2,id,color, thickness);
		this.lineLines[index]=s;
		return s;
	},
	addPlane: function(l1, t1, l2, t2, l3, t3, l4, t4, id, index, color){
		var s=new SvgPlane(l1, t1, l2, t2, l3, t3, l4, t4, id, color);
		this.planes[index]=s;
		return s;
	},
	addSphere: function(id, index, color){
		var s=new SvgSphere(id, color);
		this.spheres[index]=s;
		return s;
	},
	addLightSource: function(id, index, color){
		var s=new SvgSphere(id, color);
		this.lightSources[index]=s;
		return s;
	},
	init: function(){
		var where=document.getElementById('viewPort');
		var self=this;
		var makeAxisAndLabel=function(axisName){
			var line=document.createElement('line');
			line.setAttribute('x1', 0);
			line.setAttribute('y1', 0);
			line.setAttribute('x2', 0);
			line.setAttribute('y2', 0);
			line.setAttribute('style', 'stroke:rgb(100,100,100);stroke-width:0.5');
			line.setAttribute('id',axisName+'Axis');
			var text=document.createElement('text');
			text.setAttribute('x', 0);
			text.setAttribute('y', 0);
			text.setAttribute('fill', 'rgb(100,100,100)');
			text.setAttribute('id', axisName+'AxisLabel');
			text.appendChild(document.createTextNode(axisName));
			return {axis:line,label:text};
		};

		//make the actual svg node
		(function(){
			var NS="http://www.w3.org/2000/svg";
			var svgNode=document.createElementNS(NS,"svg");
			//var svgNode=document.createElement('svg');
			svgNode.ontouchstart=function(event){self.onTouchStart(event);};
			svgNode.ontouchmove=function(event){self.onTouchMove(event);};
			svgNode.ontouchend=function(event){self.onTouchEnd(event);};
			svgNode.onmousedown=function(event){self.onMouseDown(event);};
			svgNode.onmouseup=function(event){self.onMouseUp(event);};
			svgNode.onmousemove=function(event){self.onMouseMove(event);};
			svgNode.setAttribute('id','viewPortSvg');
			svgNode.setAttribute('width','100%');
			svgNode.setAttribute('height','100%');
			svgNode.setAttribute('style', 'border: 1px solid #000000');
			var al=makeAxisAndLabel('x');
			svgNode.appendChild(al.axis);
			svgNode.appendChild(al.label);
			al=makeAxisAndLabel('y');
			svgNode.appendChild(al.axis);
			svgNode.appendChild(al.label);
			al=makeAxisAndLabel('z');
			svgNode.appendChild(al.axis);
			svgNode.appendChild(al.label);
			where.appendChild(svgNode);
		})();

		
		var positionString=function(offset){
			return (offset.left||offset.right)?('position:absolute; '+(offset.left?'left: '+offset.left+'; ':'right: '+offset.right+'; ')+(offset.top?'top: '+offset.top+'; ':'bottom: '+offset.bottom+'; ')):'';
		};
		var sizeString=function(size){
			return size?((size.width?'width: '+size.width+'; ':'')+(size.height?'height: '+size.height+'; ':'')):'';
		};
		var makeButton=function(offset, text, onmousedown, onmouseup, opacity, size){
			var opacityString=opacity?'opacity: '+opacity+'; ':'';
			var button=document.createElement('div');
			button.setAttribute('style', positionString(offset)+'-webkit-appearance: button;cursor: hand;padding:5px;font-family:Arial; '+opacityString+sizeString(size));
			button.onmousedown=function(event){
				self.preventDefault(event);
				if(event.which!=1){return;}
				
				onmousedown.call(null);
			};
			var stopFunction=function(){
				if(onmouseup){
					onmouseup.call(null);
				}
			};
			button.onmouseup=stopFunction;
			button.onmouseleave=stopFunction;
			//button.onmouseup=onmouseup||function(){};
			button.appendChild(document.createTextNode(text));
			return button;
		};
		var makeTable=function(nodesInCells, rowHeights){
			var table=document.createElement('table');
			table.setAttribute('style', 'width:100%;height:100%;margin:0px;padding:0px;border-spacing:0px');
			for(var i=0;i<nodesInCells.length;i++){
				var row=document.createElement('tr');
				row.setAttribute('style','margin:0px;padding:0px');
				if(rowHeights){row.setAttribute('height', rowHeights[i]);}
				for(var j=0;j<nodesInCells[i].length;j++){
					var td=document.createElement('td');
					td.setAttribute('style','margin:0px;padding:0px');
					td.appendChild(nodesInCells[i][j]);
					row.appendChild(td);
				}
				table.appendChild(row);
			}
			return table;
		};

		//dialog box for displaying xml
		var xmlDialog=(function(){
			var xmlDialog=document.createElement('div');
			xmlDialog.setAttribute('style', 'position:absolute;left:80;top:60;background-color:rgb(200,200,200);padding:5px;border:1pt solid rgb(100,100,100);width:70%;height:70%;display:none');
			var button=makeButton({},'OK',function(){xmlDialog.style.display='none';}, function(){}, 1, {width:100});
			var text=document.createElement('textarea');
			text.setAttribute('style', 'resize:none;width:100%;height:100%');
			var table=makeTable([[text],[button]],['90%','10%']);
			xmlDialog.appendChild(table);
			where.appendChild(xmlDialog);
			return {dialog: xmlDialog,text: text};
		})();

		//button for displaying xml
		var showXml=function(string){
			var s=string;
			var lines=s.split('<');
			var indent='';
			var minus, equal, line;
			for(var i=1;i<lines.length;i++){
				line=lines[i];
				if(line[0]=='/'){indent=indent.substring(2);}
				lines[i]=indent+'<'+line;
				if(line[0]!='/'&&line.slice(-2)!='/>'){indent=indent+'  ';}
			}
			var s1=lines.join('\n').replace(/^\n/g, '');
			xmlDialog.dialog.style.display="initial";
			xmlDialog.text.value=s1;
		};
		var sceneXml=function(){
			var s='<?xml version="1.0" encoding="UTF-8"?><scene xmlns="http://www.sogyo.nl/efokkema_raytrace" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ><group>';
			var planes=PlaneFactory.planes;
			for(var i=0;i<planes.length;i++){
				s+=planes[i].toString();
			}
			var lightSources=LightSourceFactory.lightSources;
			for(var i=0;i<lightSources.length;i++){
				s+=lightSources[i].toString();
			}
			var spheres=SphereFactory.spheres;
			for(var i=0;i<spheres.length;i++){
				s+=spheres[i].toString();
			}
			return s+'</group>'+viewPort.toString()+'</scene>';
		};
		where.appendChild(makeButton({left:20,top:20},'hoi',function(){showXml(sceneXml());}, function(){},0.5));

		//dialog box for displaying shape list
		var shapeListDialog=(function(){
			var shapeListDialog=document.createElement('div');
			shapeListDialog.setAttribute('style', 'position:absolute;left:80;top:60;padding:0px;width:40%;min-width:450;height:70%;display:none;font-family:Arial');
			var button=makeButton({},'DONE',function(){shapeListDialog.style.display='none';}, function(){}, 1, {width:100});
			var text=document.createElement('div');
			text.setAttribute('style','width:100%;height:100%;overflow:scroll;padding:0px;margin:0px');
			var table=makeTable([[text],[button]],['90%','10%']);
			shapeListDialog.appendChild(table);
			where.appendChild(shapeListDialog);
			return {dialog: shapeListDialog,text:text};
		})();

		//button for displaying shape list
		var showShapeList=function(table){
			shapeListDialog.dialog.style.display="initial";
			shapeListDialog.text.innerHTML="";
			shapeListDialog.text.appendChild(table);
		};
		var sceneShapeList=function(){
			var makeRow={
				"valueBox": function(name, value){
					var box=document.createElement('div');
					box.appendChild(document.createTextNode(name+value));
					return box;
				},
				"colorBox": function(color){
					var box=document.createElement('div');
					box.setAttribute('style','border: 1pt solid #000000;width:40px;height:40px;background-color: '+color.toString());
					return box;
				},
				"pointBox": function(x,y,z){
					var box=document.createElement('div');
					box.setAttribute('style','border: 1pt solid rgb(150,150,150)');
					var table=makeTable([[this["valueBox"]('x: ', x),this["valueBox"]('y: ',y),this["valueBox"]('z: ',z)]]);
					box.appendChild(table);
					return box;
				},
				"propertyRow": function(name, node){
					var row=document.createElement('div');
					row.setAttribute('style','height:50px');
					var table=makeTable([[document.createTextNode(name),node]]);
					row.appendChild(table);
					return row;
				},
				"rowContainer": function(title, content){
					var row=document.createElement('div');
					row.setAttribute('style','border:1pt solid #000000;border-radius:3px;margin:5px;padding:2px;background-color:rgb(230,230,230)');
					var titleDiv=document.createElement('div');
					titleDiv.setAttribute('style','font-weight:bold');
					titleDiv.appendChild(document.createTextNode(title));
					row.appendChild(titleDiv);
					var contentDiv=document.createElement('div');
					contentDiv.appendChild(content);
					row.appendChild(contentDiv);
					return row;
				},
				"plane": function(plane){
					var content=document.createElement("div");
					var point=plane.point;
					content.appendChild(this["propertyRow"]('point: ', this["pointBox"](point.x, point.y, point.z)));
					var normal=plane.normal;
					content.appendChild(this["propertyRow"]('normal:', this["pointBox"](normal.x, normal.y, normal.z)));
					content.appendChild(this["propertyRow"]('color:', this["colorBox"](plane.color)));
					return this["rowContainer"]("plane",content);
				},
				"sphere": function(sphere){
					var content=document.createElement("div");
					var center=sphere.center;
					content.appendChild(this["propertyRow"]('center: ', this["pointBox"](center.x, center.y, center.z)));
					content.appendChild(this["propertyRow"]('radius: ',this["valueBox"]('', sphere.radius)));
					content.appendChild(this["propertyRow"]('color:', this["colorBox"](sphere.color)));
					return this["rowContainer"]("sphere",content);
				},
				"lightsource": function(lightSource){
					var content=document.createElement("div");
					var center=lightSource.center;
					content.appendChild(this["propertyRow"]('location: ', this["pointBox"](center.x, center.y, center.z)));
					content.appendChild(this["propertyRow"]('radius: ',this["valueBox"]('', lightSource.radius)));
					content.appendChild(this["propertyRow"]('color:', this["colorBox"](lightSource.color)));
					return this["rowContainer"]("light source",content);
				}
			};
			var rows=[];
			var lightSources=LightSourceFactory.lightSources;
			for(var i=0;i<lightSources.length;i++){
				rows.push(makeRow["lightsource"](lightSources[i]));
			}
			var planes=PlaneFactory.planes;
			for(var i=0;i<planes.length;i++){
				rows.push(makeRow["plane"](planes[i]));
			}
			var spheres=SphereFactory.spheres;
			for(var i=0;i<spheres.length;i++){
				rows.push(makeRow["sphere"](spheres[i]));
			}
			var table=document.createElement('div');
			table.setAttribute('style','width:100%;height:100%');
			for(var i=0;i<rows.length;i++){
				table.appendChild(rows[i]);
			}
			return table;
		};
		where.appendChild(makeButton({left:20,top:50},'hoi2', function(){showShapeList(sceneShapeList());}, function(){},0.5));

		//mover buttons
		var newMover=function(move, moveAmount, increaseMoveAmount){
			var mouseDown=false;
			var currentMoveAmount=moveAmount;
			var doMove=function(){
				if(mouseDown){
					move(currentMoveAmount);
					if(increaseMoveAmount){currentMoveAmount=increaseMoveAmount(currentMoveAmount);}
					setTimeout(doMove,50);
				}
			};
			return {
				onmousedown: function(){mouseDown=true;doMove();},
				onmouseup: function(){mouseDown=false;currentMoveAmount=moveAmount;}
			};
		};
		var newSlideMover=function(move, scaleMove){
			var mouseDown=false;
			var currentMoveAmount;
			var doMove=function(){
				if(mouseDown){
					move(currentMoveAmount);
					setTimeout(doMove, 50);
				}
			};
			var setMoveAmount=function(x,y){
				currentMoveAmount=scaleMove(x,y);
			};
			return {
				onmousedown: function(x,y){
					setMoveAmount(x,y);
					mouseDown=true;
					doMove();
				},
				onmousemove: function(x,y){
					if(mouseDown){setMoveAmount(x,y);}
				},
				onmouseup: function(){mouseDown=false;}
			};
		};
		var makeSlider=function(offset, size, orientation){
			var rectangle=function(offset,size){
				var node=document.createElement('div');
				node.setAttribute('style',positionString(offset)+sizeString(size)+'background-color: rgb(200,200,200);border:1pt solid rgb(100,100,100)');
				return node;
			};
			var slideBar=(function(){
				var thisOffset;
				if(orientation==0){
					thisOffset=offset.left?{left:offset.left}:{right:offset.right};
					if(offset.top){
						thisOffset.top=offset.top+size.height/3;
					}else{
						thisOffset.bottom=offset.bottom+size.height/3;
					}
					return rectangle(thisOffset, {width:size.width,height: size.height/3});
				}else{
					thisOffset=offset.top?{top:offset.top}:{bottom:offset.bottom};
					if(offset.left){
						thisOffset.left=offset.left+size.width/3;
					}else{
						thisOffset.right=offset.right+size.width/3;
					}
					return rectangle(thisOffset, {width:size.width/3,height: size.height});
				}
			})();
			var slideHandle=(function(){
				var r=1/6;
				var thisOffset;
				if(orientation==0){
					thisOffset=offset.top?{top:offset.top}:{bottom:offset.bottom};
					if(offset.left){
						thisOffset.left=offset.left+size.width*(1-r)/2;
					}else{
						thisOffset.right=offset.right+size.width*(1-r)/2;
					}
				}else{
					thisOffset=offset.left?{left:offset.left}:{right:offset.right};
					if(offset.top){
						thisOffset.top=offset.top+size.height*(1-r)/2;
					}else{
						thisOffset.bottom=offset.bottom+size.height*(1-r)/2;
					}
				}
				var handle=rectangle(thisOffset,orientation==0?{width:size.width*r,height:size.height}:{width:size.width,height:size.height*r});
				return handle;
			})();

			return {bar:slideBar,handle:slideHandle};
		};

		var slider=makeSlider({right:20,top:100}, {width:30,height:200},1);
		where.appendChild(slider.bar);
		where.appendChild(slider.handle);

		var scaleMoverUp=newMover(function(a){viewPort.scale(a);drawThings();}, 1.01,function(a){return a*1.01;});
		where.appendChild(makeButton({right:20,top:20},'back up',scaleMoverUp.onmousedown,scaleMoverUp.onmouseup, 0.5));

		var scaleMoverDown=newMover(function(a){viewPort.scale(a);drawThings();}, 0.99, function(a){return a*0.99;});
		where.appendChild(makeButton({right:20,top:50},'move in',scaleMoverDown.onmousedown, scaleMoverDown.onmouseup, 0.5));
		
		var rotatorLeft=newMover(function(a){viewPort.rotY(a);drawThings();}, 0.01, function(a){return a+0.01;});
		where.appendChild(makeButton({left:20,bottom:20},'<', rotatorLeft.onmousedown, rotatorLeft.onmouseup, 0.5));
		
		var rotatorClock=newMover(function(a){viewPort.rotZ(a);drawThings();}, 0.01,function(a){return a+0.01});
		where.appendChild(makeButton({left:50,bottom:20}, 'rot. clockwise', rotatorClock.onmousedown, rotatorClock.onmouseup, 0.5));
		document.body.onload=function(){
			console.log("[body] onload begin!");
			//loading message
			(function(){
				var message=document.createElement('a');
				message.setAttribute('style','position:absolute;left:0;top:0;color:#FFFFFF');
				message.setAttribute('id','loading_message');
				message.appendChild(document.createTextNode("something seems to have gone wrong! try redloading."));
				where.appendChild(message);
				console.log("added loading message");
			})();
			(function(){
				console.log("begin adding shapes...");
				PlaneFactory.makePlane(new threeD.Point(0,-1,0), new threeD.Point(0,1,0), new Color(80,20,20)).setColor(new Color(80,80,20));
				//SphereFactory.makeSphere(new threeD.Point(0,0,1), 0.1, new Color(20,80,20));
				//SphereFactory.makeSphere(new threeD.Point(1,0,1), 0.1, new Color(20,80,20));
				//SphereFactory.makeSphere(threeD.or, 0.3,new Color(20,80,20));
				LightSourceFactory.makeLightSource(new threeD.Point(0,15,0), 3,new Color(255,255,255)).setColor(new Color(100,100,255));
				SphereFactory.makeSphere(new threeD.Point(-2,2,0),1,new Color(20,80,20));
				SphereFactory.makeSphere(new threeD.Point(2,2,0),1,new Color(20,80,20)).setColor(new Color(20,20,80));
				//PlaneFactory.makePlane(new threeD.Point(5,0,0), new threeD.Point(-1,0,0), new Color(100,0,0));
				//PlaneFactory.makePlane(new threeD.Point(0,0,5), new threeD.Point(0,0,-1), new Color(0,100,0));
				console.log("finish adding shapes");
			})();
			//document.getElementById('viewPortSvg').setAttribute('width','200');
			document.getElementById("loading_message").innerHTML='';
			console.log("hid loading message");
			var w=document.getElementById("viewPortSvg").offsetWidth;
			var h=document.getElementById("viewPortSvg").offsetHeight;
			self.setWh(w,h);
			viewPort.setWh(w,h);
			twoD.setWh(w,h);
			drawThings();
			drawThings();
			console.log("[body] onload end!");
		};
		console.log("finish init!");
		return this;
	}
}.init();

















</script>
</body>
</html>