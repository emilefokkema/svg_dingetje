<html>
<head>
	<title>SVG test 2</title>
</head>
<body style="overflow: hidden;background-color:rgb(0,0,0)">
	<div style="position:relative;border:1px solid #000000;width:100%;height:100%;background-color:#333333" id="viewPort"></div>
	<!-- <div style="position:relative;border:1px solid #000000;width:100%;height:50%;background-color:#000000" id="viewPort2"></div> -->

<script language="JavaScript">
var SvgScene=function(){
	var Color=function(r_, g_, b_){
		var r=r_;
		var g=g_;
		var b=b_;
		return {
			toString: function(){return "rgb("+r+", "+g+", "+b+")";},
			toString2: function(){return r+","+g+","+b;},
			r: function(){return r},
			g: function(){return g},
			b: function(){return b},
		};
	}

	var threeD=(function(){
		var Point=function(x_, y_, z_){
			var x=x_;
			var y=y_;
			var z=z_;
			var p={
				x: function(){return x;},
				y: function(){return y;},
				z: function(){return z;},
				plus: function(p){return Point(p.x()+x, p.y()+y,p.z()+z);},
				scale: function(r){return Point(r*x,r*y,r*z);},
				minus: function(p){return Point(x-p.x(), y-p.y(),z-p.z());},
				dot: function(p){return x*p.x()+y*p.y()+z*p.z();},
				cross: function(p){return Point(y*p.z()-z*p.y(),z*p.x()-x*p.z(),x*p.y()-y*p.x());},
				norm: function(){return Math.sqrt(x*x+y*y+z*z);},
				unit: function(){if(this.norm()==0){return this;}else{return this.scale(1/this.norm());}},
				project: function(p){
					var u=this.unit();
					return u.scale(u.dot(p));
				},
				projectOnPlane: function(p,n){
					var tmp=this.minus(p);
					return p.plus(tmp.minus(n.project(tmp)));
				},
				rotate: function(around, axis, angle){
					var op=this.minus(around);
					if(axis==0){
						var npy=op.y()*Math.cos(angle)-op.z()*Math.sin(angle);
						var npz=op.z()*Math.cos(angle)+op.y()*Math.sin(angle);
						return around.plus(Point(op.x(), npy, npz));
					}
					if(axis==1){
						var npz=op.z()*Math.cos(angle)-op.x()*Math.sin(angle);
						var npx=op.x()*Math.cos(angle)+op.z()*Math.sin(angle);
						return around.plus(Point(npx, op.y(), npz));
					}
					if(axis==2){
						var npx=op.x()*Math.cos(angle)-op.y()*Math.sin(angle);
						var npy=op.y()*Math.cos(angle)+op.x()*Math.sin(angle);
						return around.plus(Point(npx, npy, op.z()));
					}
				},
				rotateWithRotation: function(r){
					return this.rotate(r.around, r.axis, r.angle);
				},
				rotateWithOtherRotation: function(r){
					var op=this.minus(r.around);
					var opUnchanged=r.direction.project(op);
					op=op.minus(opUnchanged);
					if(op.norm()>0){
						var yAxis=r.direction.cross(op);
						op=op.scale(Math.cos(r.angle)).plus(yAxis.unit().scale(op.norm()*Math.sin(r.angle)));
						return r.around.plus(opUnchanged).plus(op);
					}else{
						return Point(x, y, z);
					}
				},
				perpendicularTo: function(p){return Math.abs(this.dot(p))<0.0005;},
				isZero: function(){return x==0&&y==0&&z==0;},
				equals: function(p){return x==p.x()&&y==p.y()&&z==p.z();},
				sameDirection: function(p){return !this.isZero()&&!p.isZero()&&(this.dot(p)==this.norm()*p.norm());},
				toString: function(){return '('+x+','+y+','+z+')';}
			};
			return p;
		};
		var Line=function(point1, point2){
			var p1=point1;
			var baseVector=point2.minus(point1);
			var intersectWithPlane=function(point, normal){
				if(baseVector.perpendicularTo(normal)){return null;}
				var t=-normal.dot(p1.minus(point))/normal.dot(baseVector);
				return p1.plus(baseVector.scale(t));
			};
			var l={
				p1: function(){return p1;},
				baseVector: function(){return baseVector;},
				intersectWithPlane: intersectWithPlane
			};
			return l;
		};
		var Rotation=function(around, axis, angle){
			return {
				around: around,
				axis: axis,
				angle: angle
			};
		};
		var OtherRotation=function(around, axisDirection, angle){
			return {
				around: around,
				direction: axisDirection,
				angle: angle
			};
		};
		var or=Point(0,0,0);
		var xu=Point(1,0,0);
		var yu=Point(0,1,0);
		var zu=Point(0,0,1);
		return {
			Point: Point,
			Line: Line,
			Rotation: Rotation,
			OtherRotation: OtherRotation,
			or: or,
			xu: xu,
			yu: yu,
			zu: zu
		};
	})();
	var Point=threeD.Point;
	var Line=threeD.Line;
	var OtherRotation=threeD.OtherRotation;
	var Rotation=threeD.Rotation;
	var or=threeD.or;
	var xu=threeD.xu;
	var yu=threeD.yu;
	var zu=threeD.zu;

	var twoD=(function(){
		var w,h,corners,ltcorners;
		var d=function(lt1, lt2){return plt(lt1).minus(plt(lt2)).norm();};
		var p=function(x,y){return Point(x,y,0);};
		var plt=function(lt){return p(lt.left, lt.top);};
		var ltp=function(p){return {left:p.x(),top:p.y()};};
		var intersectLineSegments=function(p1,p2,p3,p4){
			var a=p2.minus(p1);
			var b=p4.minus(p3);
			var c=p3.minus(p1);
			var d=a.cross(b);
			var nd=d.norm();
			if(nd==0){return null;}
			var i=p1.plus(a.scale(c.cross(b).dot(d)/Math.pow(nd, 2)));
			return ltp(i);
		};
		var distanceToLine=function(p1, direction, p2){
			var l=p2.minus(p1);
			return l.norm()*l.unit().dot(direction.unit());
		};
		var distanceToEdge=function(lt1, lt2){
			var direction=plt(lt2).minus(plt(lt1));
			var d=0;
			for(var i=0;i<4;i++){
				var dd=distanceToLine(plt(lt2), direction, corners[i]);
				if(dd>=d){d=dd;}
			}
			return d;
		};
		var moveToEdge=function(lt1, lt2, w, h){
			var d_=d(lt1, lt2);
			var d1=distanceToEdge(lt1, lt2);
			return {left:lt1.left+(lt2.left-lt1.left)*(1+d1/d_),top:lt1.top+(lt2.top-lt1.top)*(1+d1/d_)};
		};
		var setCorners=function(){
			corners=[p(0,0), p(0,h), p(w, h), p(w,0)];
			ltcorners=[{left:0,top:0},{left:0,top:h},{left: w, top:h},{left:w,top:0}];
		};
		var makeInfinite=function(lt1, lt2, hlt){
			var d_=d(lt1, lt2);
			var nlt1=lt1;
			var nlt2=lt2;
			if(d_!=0){
				if(lt1.left!=lt2.left){
					if(hlt!=null&&((hlt.left<lt1.left&&lt1.left<lt2.left)||(hlt.left>lt1.left&&lt1.left>lt2.left))){
						nlt1=hlt;
					}else{
						var toEdge=moveToEdge(lt2, lt1, w, h);
						nlt1=toEdge;
					}
					if(hlt!=null&&((hlt.left<lt2.left&&lt2.left<lt1.left)||(hlt.left>lt2.left&&lt2.left>lt1.left))){
						nlt2=hlt;
					}else{
						var toEdge=moveToEdge(lt1, lt2, w, h);
						nlt2=toEdge;
					}

				}else{
					if(hlt!=null&&((hlt.top<lt1.top&&lt1.top<lt2.top)||(hlt.top>lt1.top&&lt1.top>lt2.top))){
						nlt1=hlt;
					}else{
						var toEdge=moveToEdge(lt2, lt1, w, h);
						nlt1=toEdge;
					}
					if(hlt!=null&&((hlt.top<lt2.top&&lt2.top<lt1.top)||(hlt.top>lt2.top&&lt2.top>lt1.top))){
						nlt2=hlt;
					}else{
						var toEdge=moveToEdge(lt1, lt2, w, h);
						nlt2=toEdge;
					}

				}
			}
			return [nlt1, nlt2];
		};
		var completeTheSquare=function(lt1, lt2, lt3){
			var step1=plt(lt1);
			var step2=plt(lt2);
			var a=step2.minus(step1);
			var b=plt(lt3).minus(step1);
			if(a.cross(b).z()>0){
				var step3=step2.plus(Point(-a.y(), a.x(), 0));
			}else{
				var step3=step2.plus(Point(a.y(), -a.x(), 0));
			}
			var step4=step3.plus(a.scale(-1));
			return [ltp(step3),ltp(step4)];
		};
		return {
			setWh: function(w_,h_){w=w_;h=h_;setCorners();},
			ltcorners: function(){return ltcorners;},
			makeInfinite: makeInfinite,
			completeTheSquare: completeTheSquare
		};
	})();

	var viewPort=(function(){
		var w,h,normal;
		var leftTop=Point(1, 1, -1);
		var leftAxis=Point(-1,0,0);
		var topAxis=Point(0,-1,0);
		var viewPoint=Point(0,0,-2);
		var setSize=function(){
			var r=h/w;
			leftTop=Point(0.5, 0.5*r,-1);
			topAxis=topAxis.scale(r);
			normal=leftAxis.cross(topAxis);
		};
		var setScale=function(r){
			leftAxis=leftAxis.scale(r);
			topAxis=topAxis.scale(r);
		};
		var setUp=function(leftTop_, leftAxis_, topAxis_, viewPoint_){
			leftTop=leftTop_;
			leftAxis=leftAxis_;
			topAxis=topAxis_.unit().scale(leftAxis_.norm()*h/w);
			normal=leftAxis.cross(topAxis);
			viewPoint=viewPoint_;
			var middle=leftTop.plus(leftAxis.plus(topAxis).scale(0.5));
			viewPoint=middle.plus(viewPoint.minus(middle).minus(viewPoint.minus(middle).projectOnPlane(or, normal)));
			var crossX=topAxis.unit().cross(leftAxis.cross(or.minus(viewPoint)).unit());
			var dirX=crossX.dot(leftAxis)>=0?-1:1;
			var angleX=dirX*Math.asin(crossX.norm());
			rot2X(angleX);
			var crossY=leftAxis.unit().cross(topAxis.cross(or.minus(viewPoint)).unit());
			var dirY=crossY.dot(topAxis)>=0?-1:1;
			var angleY=dirY*Math.asin(crossY.norm());
			rot2Y(angleY);
		};
		var horizonLt=function(line){
			var direction=line.baseVector();
			if(direction.perpendicularTo(normal)){return null;}
			if(direction.dot(normal)<0){direction=direction.scale(-1);}
			return lt(viewPoint.plus(direction));
		};
		var getVisiblePointsOn=function(line){
			if(line.baseVector().perpendicularTo(normal)){
				if(line.p1().minus(viewPoint).dot(normal)>0){return [lt(line.p1()), lt(line.p1().plus(line.baseVector()))];}
				else{return [null, null];}
			}
			var p1=line.intersectWithPlane(leftTop, normal);
			var p2=p1.scale(0.5).plus(line.intersectWithPlane(viewPoint, normal).scale(0.5));
			return [lt(p1),lt(p2)];
		};
		var getVisiblePointsBetween=function(p1, p2){
			var ltp1=lt(p1);
			var ltp2=lt(p2);
			if(ltp1==null&&ltp2==null){return [null, null];}
			if(ltp1!=null&&ltp2!=null){return [ltp1, ltp2];}
			var p3=Line(p1,p2).intersectWithPlane(viewPoint, normal);
			if(p3==null){return [null, null];}
			if(ltp1==null){
				return [lt(p2.plus(p3).scale(0.5)), ltp2];
			}
			if(ltp2==null){
				return [ltp1, lt(p1.plus(p3).scale(0.5))];
			}
		};
		var lt=function(point){
			var line=Line(viewPoint, point);
			if(line.baseVector().perpendicularTo(normal)){return null;}
			var t=-normal.dot(viewPoint.minus(leftTop))/normal.dot(line.baseVector());
			if(t<0){return null;}
			var inPlane=viewPoint.plus(line.baseVector().scale(t));
			var leftTopToInPlane=inPlane.minus(leftTop);
			var l=leftAxis.unit().dot(leftTopToInPlane)/leftAxis.norm();
			var t=topAxis.unit().dot(leftTopToInPlane)/topAxis.norm();
			return {left: l*w,top: t*h};
		};
		var rotateWithOtherRotation=function(r){
			leftAxis=leftTop.plus(leftAxis);
			topAxis=leftTop.plus(topAxis);
			leftTop=leftTop.rotateWithOtherRotation(r);
			leftAxis=leftAxis.rotateWithOtherRotation(r).minus(leftTop);
			topAxis=topAxis.rotateWithOtherRotation(r).minus(leftTop);
			viewPoint=viewPoint.rotateWithOtherRotation(r);
			normal=leftAxis.cross(topAxis);
		};
		var rotX=function(angle){
			rotateWithOtherRotation(OtherRotation(or, leftAxis, angle));
		};
		var rotY=function(angle){
			rotateWithOtherRotation(OtherRotation(or, topAxis, angle));
		};
		var rotZ=function(angle){
			rotateWithOtherRotation(OtherRotation(or, leftAxis.cross(topAxis), angle));
		};
		var rot2X=function(angle){
			rotateWithOtherRotation(OtherRotation(viewPoint, leftAxis, angle));
		};
		var rot2Y=function(angle){
			rotateWithOtherRotation(OtherRotation(viewPoint, topAxis, angle));
		};
		var scale=function(r){
			leftTop=leftTop.scale(r);
			leftAxis=leftAxis.scale(r);
			topAxis=topAxis.scale(r);
			viewPoint=viewPoint.scale(r);
			normal=leftAxis.cross(topAxis);
		};
		var scale2=function(r){
			var middleOfView=leftTop.plus(leftAxis.plus(topAxis).scale(0.5));
			viewPoint=middleOfView.plus(viewPoint.minus(middleOfView).scale(r));
		};
		var toString=function(){
			var s='<viewport w="'+w+'" h="'+h+'">';
			s+='<lefttop x="'+leftTop.x()+'" y="'+leftTop.y()+'" z="'+leftTop.z()+'" />';
			s+='<leftaxis x="'+leftAxis.x()+'" y="'+leftAxis.y()+'" z="'+leftAxis.z()+'" />';
			s+='<topaxis x="'+topAxis.x()+'" y="'+topAxis.y()+'" z="'+topAxis.z()+'" />';
			s+='<viewpoint x="'+viewPoint.x()+'" y="'+viewPoint.y()+'" z="'+viewPoint.z()+'" />';
			s+='</viewport>';
			return s;
		};
		var toString2=function(){
			return '{lefttop: ['+leftTop.x()+','+leftTop.y()+','+leftTop.z()+'], leftaxis: ['+leftAxis.x()+','+leftAxis.y()+','+leftAxis.z()+'], topaxis: ['+topAxis.x()+','+topAxis.y()+','+topAxis.z()+'], viewpoint: ['+viewPoint.x()+','+viewPoint.y()+','+viewPoint.z()+']}';
		};
		return {
			lt: lt,
			setWh: function(w_, h_){w=w_; h=h_; setSize();},
			leftTop: function(){return leftTop;},
			leftAxis: function(){return leftAxis;},
			topAxis: function(){return topAxis},
			normal: function(){return normal;},
			viewPoint: function(){return viewPoint;},
			rotX: rotX,
			rotY: rotY,
			rotZ: rotZ,
			rot2X: rot2X,
			rot2Y: rot2Y,
			getVisiblePointsBetween: getVisiblePointsBetween,
			getVisiblePointsOn: getVisiblePointsOn,
			toString: toString,
			toString2: toString2,
			scale: scale,
			scale2: scale2,
			horizonLt: horizonLt,
			setUp: setUp
		};
	})();
	
	var LineSegmentFactory=(function(){
		var lineSegments=[];
		var currentNumber=0;
		var LineSegment=function(from_, to_){
			var from, to, thisSvg;
			var setFromTo=function(from_, to_){
				from=from_;
				to=to_;
			};
			var draw=function(){
				var visible=viewPort.getVisiblePointsBetween(from, to);
				var flt=visible[0];
				var tlt=visible[1];
				if(flt==null||tlt==null){
					thisSvg.none();
				}else{
					thisSvg.setFromTo(flt, tlt);
					thisSvg.draw();
				}
			};
			var setColor=function(color){
				thisSvg.setColor(color);
			};
			var setSvg=function(svg_){
				thisSvg=svg_;
			};
			setFromTo(from_, to_);
			return {
				setFromTo: setFromTo,
				draw: draw,
				setColor: setColor,
				setSvg: function(svg_){setSvg(svg_); return this;}
			};
		};
		var makeLineSegment=function(from, to, color, thickness){
			var id="lineSegment"+currentNumber;
			var index=currentNumber;
			var svgThing=svg.addLineSegment(0,0,0,0, id, index, color, thickness);
			var ls=LineSegment(from, to).setSvg(svgThing);
			lineSegments[currentNumber]=ls;
			currentNumber++;
			return ls;
		};
		var draw=function(){for(var i=0;i<lineSegments.length;i++){
			lineSegments[i].draw();
		}};
		return {
			makeLineSegment: makeLineSegment,
			lineSegments: function(){return lineSegments;},
			draw: draw
		};
	})();

	var LineLineFactory=(function(){
		var lineLines=[];
		var currentNumber=0;
		var LineLine=function(p1_, p2_){
			var p1,p2,line,thisSvg;
			var setFromTo=function(p1_,p2_){
				p1=p1_;
				p2=p2_;
				line=Line(p1_,p2_);
			};
			var draw=function(){
				var visible=viewPort.getVisiblePointsOn(line);
				var p1lt=viewPort.lt(p1);
				if(p1lt==null){p1lt=visible[0];}
				var p2lt=viewPort.lt(p2);
				if(p2lt==null){p2lt=visible[1];}
				var hlt=viewPort.horizonLt(line);
				if(p1lt==null&&p2lt==null){
					thisSvg.none();
				}else{
					thisSvg.setFromTo(p1lt, p2lt);
					thisSvg.makeInfinite(hlt);
				}
				thisSvg.draw();
			};
			var setColor=function(color){
				thisSvg.setColor(color);
			};
			var setSvg=function(svg_){
				thisSvg=svg_;
			};
			setFromTo(p1_,p2_);
			return {
				setFromTo: setFromTo,
				draw: draw,
				setColor: setColor,
				setSvg: function(svg_){setSvg(svg_); return this;}
			};
		};
		var makeLineLine=function(p1, p2, color, thickness){
			var id="lineLine"+currentNumber;
			var index=currentNumber;
			var svgThing=svg.addLineLine(0,0,0,0, id, index, color, thickness);
			var ll=LineLine(p1, p2).setSvg(svgThing);
			lineLines[currentNumber]=ll;
			currentNumber++;
			return ll;
		};
		var draw=function(){
			for(var i=0;i<lineLines.length;i++){
				lineLines[i].draw();
			}
		};
		return {
			makeLineLine: makeLineLine,
			lineLines: function(){return lineLines;},
			draw: draw
		};
	})();

	var PlaneFactory=(function(){
		var planes=[];
		var currentNumber=0;
		var Plane=function(point_, normal_, color_){
			var point, normal, color, thisSvg, gridLines, xAxis, yAxis;
			point=point_;
			normal=normal_;
			color=color_;
			var setAxes=function(){
				if(normal.cross(xu).norm()!=0){
					xAxis=point.plus(xu).projectOnPlane(point, normal).minus(point).unit();
				}
				else if(normal.cross(yu).norm()!=0){
					xAxis=point.plus(yu).projectOnPlane(point, normal).minus(point).unit();
				}
				else if(normal.cross(zu).norm()!=0){
					xAxis=point.plus(zu).projectOnPlane(point, normal).minus(point).unit();
				}
				yAxis=normal.cross(xAxis);
			};
			var getHorizonLts=function(){
				var horizonDirections=[];
				horizonDirections[0]=normal.cross(viewPort.leftAxis());
				horizonDirections[1]=normal.cross(horizonDirections[0]);
				horizonDirections[2]=horizonDirections[0].plus(horizonDirections[1]);
				horizonDirections[3]=normal.cross(viewPort.topAxis());
				horizonDirections[4]=normal.cross(horizonDirections[3]);
				horizonDirections[5]=horizonDirections[3].plus(horizonDirections[4]);
				var nonNullHlt=[];
				var count=0;
				for(var i=0;i<horizonDirections.length;i++){
					var hlt=viewPort.horizonLt(Line(point, point.plus(horizonDirections[i])));
					if(hlt!=null){
						nonNullHlt[count++]=hlt;
					}
					if(count==2){break;}
				}
				return nonNullHlt;
			};
			var getInPlaneLt=function(){
				var lt_;
				var inPlane1=Line(viewPort.leftTop(), viewPort.leftTop().plus(viewPort.leftAxis())).intersectWithPlane(point, normal);
				var inPlane2=Line(viewPort.leftTop(), viewPort.leftTop().plus(viewPort.topAxis())).intersectWithPlane(point, normal);
				if(inPlane1==null){
					lt_=viewPort.lt(inPlane2);
				}else{
					lt_=viewPort.lt(inPlane1);
				}
				return lt_;
			};
			var pointWithCoords=function(x,y){
				return point.plus(xAxis.scale(x)).plus(yAxis.scale(y));
			};
			var getPairwiseGridPoints=function(){
				var gp=[];
				var n=20;
				var f=function(i){return i+Math.pow(i, 3)/5;}
				for(var i=-n;i<=n;i++){
					gp.push([pointWithCoords(f(i),n), pointWithCoords(f(i),-n)]);
					gp.push([pointWithCoords(-n,f(i)), pointWithCoords(n,f(i))]);
				}
				return gp;
			};
			var draw=function(){
				if(normal.cross(viewPort.normal()).norm()==0){
					if(point.minus(viewPort.viewPoint()).dot(viewPort.normal())>=0){thisSvg.full();}else{thisSvg.none();}
					thisSvg.draw();
					return;
				}
				var nonNullHlt=getHorizonLts();
				thisSvg.setHorizonPoints(nonNullHlt[0], nonNullHlt[1], getInPlaneLt());
				thisSvg.draw();
			};
			var setColor=function(color_){
				color=color_;
				thisSvg.setColor(color_);
				for(var i in gridLines){gridLines[i].setColor(color_);}
			};
			var setPointAndNormal=function(point_, normal_){
				if(!point_.equals(point)||!normal_.equals(normal)){
					console.log("[plane] setting point "+point_.toString()+" and normal "+normal_.toString()+"!");
					point=point_;
					normal=normal_;
					setAxes();
					setGrid();
				}
			};
			var toString=function(){
				return '<plane reflection="0.5" diffusion="0.5" color="'+color.toString2()+'">'+
				'<point x="'+point.x()+'" y="'+point.y()+'" z="'+point.z()+'"/>'+
				'<normal x="'+normal.x()+'" y="'+normal.y()+'" z="'+normal.z()+'"/>'+
				'</plane>';
			};
			var toString2=function(){
				return '{type: "plane", point: ['+point.x()+','+point.y()+','+point.z()+'], normal: ['+normal.x()+','+normal.y()+','+normal.z()+'], color: ['+color.toString2()+']}';
			};
			var setSvg=function(svg_){
				thisSvg=svg_;
			};
			var setGrid=function(){
				var pairwiseGridPoints=getPairwiseGridPoints();
				for(var i in pairwiseGridPoints){
					gridLines[i].setFromTo(pairwiseGridPoints[i][0],pairwiseGridPoints[i][1]);
				}
			};
			var makeGrid=function(){
				gridLines=[];
				var pairwiseGridPoints=getPairwiseGridPoints();
				for(var i in pairwiseGridPoints){
					gridLines.push(LineLineFactory.makeLineLine(pairwiseGridPoints[i][0],pairwiseGridPoints[i][1], color, 0.5));
				}
			};
			setAxes();
			makeGrid();
			return {
				draw: draw,
				setColor: setColor,
				setSvg: function(svg_){setSvg(svg_);return this;},
				toString: toString,
				toString2: toString2,
				point: function(){return point;},
				normal: function(){return normal;},
				color: function(){return color;},
				setPointAndNormal: setPointAndNormal
			};
		};
		var makePlane=function(point, normal, color){
			var id="plane"+currentNumber;
			var index=currentNumber;
			var svgThing=svg.addPlane(0,0,0,0,0,0,0,0,id,index, color);
			var p=Plane(point, normal, color).setSvg(svgThing);
			planes[currentNumber]=p;
			currentNumber++;
			return p;
		};
		var draw=function(){for(var i=0;i<planes.length;i++){planes[i].draw();}};
		return {
			makePlane: makePlane,
			planes: function(){return planes;},
			draw:draw
		};
	})();

	var SphereFactory=(function(){
		var spheres=[];
		var lightSources=[];
		var currentNumber=0;
		var Sphere=function(center_, radius_, color_, toBecomeLightSource){
			var center, radius, color, gridLineSegments, thisSvg;
			center=center_;
			radius=radius_;
			color=color_;
			var draw=function(){
				var toCenter=center.minus(viewPort.viewPoint());
				var d=toCenter.norm();
				var r=radius;
				if(d<=r){thisSvg.none();thisSvg.draw();return;}
				var startingPoint=center.plus(toCenter.cross(viewPort.leftAxis()).unit().scale(d*r/Math.sqrt(d*d-r*r)));
				var pointList=[startingPoint];
				var n=24;
				var rot=OtherRotation(viewPort.viewPoint(), toCenter, 2*Math.PI/n);
				for(var i=1;i<n;i++){
					startingPoint=startingPoint.rotateWithOtherRotation(rot);
					pointList[pointList.length]=startingPoint;
				}
				var ltList=[];
				for(var i=0;i<pointList.length;i++){
					var lt=viewPort.lt(pointList[i]);
					if(lt!=null){ltList[ltList.length]=lt;}
				}
				thisSvg.setPoints(ltList);
				thisSvg.draw();
			};
			var setColor=function(color_){
				color=color_;
				thisSvg.setColor(color);
				for(var i in gridLineSegments){gridLineSegments[i].setColor(color_);}
			};
			var setCenterAndRadius=function(center_,radius_){
				if(!center_.equals(center)||radius_!=radius){
					center=center_;
					radius=radius_;
					setGrid();
				}
			};
			var pointWithCoords=function(lo, la){
				return center.plus(xu.rotate(or, 2, la).rotate(or, 1, lo).scale(radius));
			};
			var getPairwiseGridPoints=function(){
				var gp=[];
				for(var lo=-Math.PI;lo<=Math.PI;lo+=Math.PI/8){
					var pointsOnMeridian_=pointsOnMeridian(lo,20);
					for(var i=1;i<pointsOnMeridian_.length;i++){
						gp.push([pointsOnMeridian_[i-1], pointsOnMeridian_[i]]);
					}
				}
				for(var la=-Math.PI/2;la<=Math.PI/2;la+=Math.PI/8){
					var pointsOnLatitude_=pointsOnLatitude(la, 20);
					for(var i=1;i<pointsOnLatitude_.length;i++){
						gp.push([pointsOnLatitude_[i-1], pointsOnLatitude_[i]]);
					}
				}
				return gp;
			};
			var pointsOnMeridian=function(lo, n){
				var pointsOnMeridian_=[];
				for(var la=-Math.PI/2; la<=Math.PI/2; la+=Math.PI/n){
					pointsOnMeridian_[pointsOnMeridian_.length]=pointWithCoords(lo,la);
				}
				return pointsOnMeridian_;
			};
			var pointsOnLatitude=function(la, n){
				var pointsOnLatitude_=[];
				for(var lo=-Math.PI;lo<=Math.PI;lo+=2*Math.PI/n){
					pointsOnLatitude_[pointsOnLatitude_.length]=pointWithCoords(lo,la);
				}
				return pointsOnLatitude_;
			};
			var setSvg=function(svg_){thisSvg=svg_;};
			var toString=(function(){
				if(!toBecomeLightSource){
					return function(){
						var s='<sphere reflection="0.5" diffusion="0.5" color="'+color.toString2()+'" radius="'+radius+'">'+
						'<center x="'+center.x()+'" y="'+center.y()+'" z="'+center.z()+'" />'+
						'</sphere>';
						return s;
					};
				}else{
					return function(){
						var s='<lightsource color="'+color.toString2()+'" radius="'+radius+'">'+
						'<location x="'+center.x()+'" y="'+center.y()+'" z="'+center.z()+'" />'+
						'</lightsource>';
						return s;
					};
				}
			})();
			var toString2=(function(){
				if(!toBecomeLightSource){
					return function(){
						//{type: "sphere",center: [0.25,0.25,0.25],radius:0.1,color:[255,255,0]},
						return '{type: "sphere", center: ['+center.x()+','+center.y()+','+center.z()+'], radius: '+radius+', color: ['+color.toString2()+']}';
					};
				}else{
					return function(){
						return '{type: "lightsource", center: ['+center.x()+','+center.y()+','+center.z()+'], radius: '+radius+', color: ['+color.toString2()+']}';
					};
				}
			})();
			var setGrid=function(){
				var pairwiseGridPoints=getPairwiseGridPoints();
				for(var i in pairwiseGridPoints){
					gridLineSegments[i].setFromTo(pairwiseGridPoints[i][0],pairwiseGridPoints[i][1]);
				}
			};
			var makeGrid=function(){
				gridLineSegments=[];
				var pairwiseGridPoints=getPairwiseGridPoints();
				for(var i in pairwiseGridPoints){
					gridLineSegments.push(LineSegmentFactory.makeLineSegment(pairwiseGridPoints[i][0],pairwiseGridPoints[i][1], color, 0.5));
				}
			};
			makeGrid();
			return {
				draw: draw,
				setColor: setColor,
				setSvg: function(svg_){setSvg(svg_);return this;},
				toString: toString,
				toString2: toString2,
				center: function(){return center;},
				radius: function(){return radius;},
				color: function(){return color;},
				setCenterAndRadius: setCenterAndRadius
			};
		};
		var makeSphere=function(center, radius, color){
			var id="sphere"+currentNumber;
			var index=currentNumber;
			var svgThing=svg.addSphere(color);
			var s=Sphere(center, radius, color, false).setSvg(svgThing);
			console.log(s.toString());
			spheres[currentNumber]=s;
			currentNumber++;
			return s;
		};
		var makeLightSource=function(center, radius, color){
			var svgThing=svg.addSphere(color);
			var s=Sphere(center, radius, color, true).setSvg(svgThing);
			lightSources.push(s);
			return s;
		};
		var draw=function(){
			for(var i=0;i<spheres.length;i++){
				spheres[i].draw();
			}
			for(var i=0;i<lightSources.length;i++){
				lightSources[i].draw();
			}
		};
		return {
			makeSphere: makeSphere,
			makeLightSource: makeLightSource,
			spheres: function(){return spheres;},
			lightSources: function(){return lightSources;},
			draw: draw
		};
	})();

	var drawThings=function(){
		svg.drawAxes();
		//var i;
		// var lineSegments=LineSegmentFactory.lineSegments();
		// for(i=0;i<lineSegments.length;i++){
		// 	lineSegments[i].draw();
		// }
		LineSegmentFactory.draw();
		// var lineLines=LineLineFactory.lineLines();
		// for(i=0;i<lineLines.length;i++){
		// 	lineLines[i].draw();
		// }
		LineLineFactory.draw();
		// var planes=PlaneFactory.planes();
		// for(i=0;i<planes.length;i++){
		// 	planes[i].draw();
		// }
		PlaneFactory.draw();
		SphereFactory.draw();
		// var spheres=SphereFactory.spheres();
		// for(i=0;i<spheres.length;i++){
		// 	spheres[i].draw();
		// }
		// var lightSources=SphereFactory.lightSources();
		// for(i=0;i<lightSources.length;i++){
		// 	lightSources[i].draw();
		// }
	};

	var svg=(function(){
		var w,h,whereSvg,where,drawAxes;
		var preventDefault=function(evt){evt.preventDefault();};
		var lineSegments=[];
		var lineLines=[];
		var planes=[];
		var spheres=[];
		var lightSources=[];
		var myMouseEvents=(function(){
			var mouseDown=false;
			return {
				onMove: function(dl, dt){
					if(mouseDown){
						viewPort.rotY(dl/500);
						viewPort.rotX(-dt/500);
						drawThings();
					}
				},
				onDown: function(){mouseDown=true;},
				onUp: function(){mouseDown=false;}
			};
		})();

		var myTouchEvents=(function(){
			var oneTouch=(function(){
				var oldx,oldy,dx,dy;
				var down=false;
				var changeTo=function(x,y){dx=x-oldx;dy=y-oldy;oldx=x;oldy=y;return {x:dx,y:dy};};
				return {
					onDown: function(x,y){changeTo(x,y);down=true;},
					onMove: function(x,y){
						if(down){
							var d=changeTo(x,y);
							viewPort.rotY(d.x/500);
							viewPort.rotX(-d.y/500);
							drawThings();
						}

					},
					onUp: function(){down=false;},
					isDown: function(){return down;}
				};
			})();
			var twoTouches=(function(){
				var oldx1,oldy1,oldx2,oldy2,oldd;
				var down=false;
				var changeTo=function(x1,y1,x2,y2){
					var dd;
					oldx1=x1;
					oldy1=y1;
					oldx2=x2;
					oldy2=y2;
					if(oldd){
						dd=Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))-oldd;
						oldd=oldd+dd;
					}
					else{
						oldd=Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));
						dd=0;
					}

					return {d:dd/oldd};
				};
				return {
					onDown: function(x1,y1,x2,y2){
						changeTo(x1,y1,x2,y2);
						down=true;
					},
					onMove: function(x1,y1,x2,y2){
						if(down){
							var d=changeTo(x1,y1,x2,y2);
							viewPort.scale(Math.pow(2,-d.d));
							drawThings();
						}
					},
					onUp: function(){down=false;},
					isDown: function(){return down;}
				};
			})();
			return {
				oneTouch: oneTouch,
				twoTouches: twoTouches
			};
		})();

		var onMouseDown=function(evt){
			preventDefault(evt);
			myMouseEvents.onDown();
		};
		var onMouseUp=function(){myMouseEvents.onUp();};
		var onMouseMove=function(evt){
			preventDefault(evt);
			var dl=evt.movementX;
			var dt=evt.movementY;
			myMouseEvents.onMove(dl, dt);
		};

		var onTouchStart=function(evt){
			preventDefault(evt);
			var touches=evt.changedTouches;
			if(touches.length==1){
				var touch=evt.changedTouches[0];
				if(!myTouchEvents.oneTouch.isDown()){myTouchEvents.oneTouch.onDown(touch.clientX, touch.clientY);}
			}
			
		};
		var onTouchEnd=function(evt){
			myTouchEvents.oneTouch.onUp();
			myTouchEvents.twoTouches.onUp();
		};
		var onTouchMove=function(evt){
			preventDefault(evt);
			var touches=evt.changedTouches;
			if(touches.length==1){
				var touch=evt.changedTouches[0];
				myTouchEvents.oneTouch.onMove(touch.clientX, touch.clientY);
			}
			else{
				var one=evt.changedTouches[0];
				var two=evt.changedTouches[1];
				var x1=one.clientX;
				var y1=one.clientY;
				var x2=two.clientX;
				var y2=two.clientY;
				if(!myTouchEvents.twoTouches.isDown()){myTouchEvents.twoTouches.onDown(x1,y1,x2,y2);}
				else{myTouchEvents.twoTouches.onMove(x1,y1,x2,y2);}

			}
		};
		var SvgLine=function(l1,t1,l2,t2,id, color, thickness){
			var svgl={};
			var svgElement=whereSvg.appendChild((function(){
				var NS="http://www.w3.org/2000/svg";
				var line=document.createElementNS(NS, 'line');
				line.setAttribute('x1', l1);
				line.setAttribute('y1', t1);
				line.setAttribute('x2', l2);
				line.setAttribute('y2', t2);
				line.setAttribute('style','stroke: '+color.toString()+'; stroke-width: '+thickness+'; stroke-opacity: 1.5');
				return line;
			})());
			var lt1={left:l1,top:t1};
			var lt2={left:l2,top:t1};
			svgl.setFromTo=function(f,t){lt1=f;lt2=t;};
			svgl.draw=function(){
				svgElement.setAttribute("x1", lt1.left);
				svgElement.setAttribute("y1", lt1.top);
				svgElement.setAttribute("x2", lt2.left);
				svgElement.setAttribute("y2", lt2.top);
			};
			svgl.setColor=function(color1){
				svgElement.setAttribute('style','stroke:'+color1.toString()+';stroke-width: '+thickness+';stroke-opacity: 1.5');
			};
			svgl.makeInfinite=function(hlt){
				var nlt=twoD.makeInfinite(lt1, lt2, hlt);
				lt1=nlt[0];
				lt2=nlt[1];
			};
			svgl.none=function(){svgl.setFromTo({left:0,top:0},{left:0,top:0});};
			return svgl;
		};
		var SvgPlane=function(l1, t1, l2, t2, l3, t3, l4, t4, id, color){
			var svgpl={};
			var svgElement=whereSvg.appendChild((function(){
				var NS="http://www.w3.org/2000/svg";
				var polygon=document.createElementNS(NS, 'polygon');
				polygon.setAttribute('points',l1+','+t1+' '+l2+','+t2+' '+l3+','+t3+' '+l4+','+t4);
				polygon.setAttribute('style','fill: '+color.toString()+'; fill-opacity: 0.4');
				//polygon.setAttribute('id',id);
				return polygon;
			})());
			var lt1={left:l1,top:t1};
			var lt2={left:l2,top:t2};
			var lt3={left:l3,top:t3};
			var lt4={left:l4,top:t4};
			svgpl.setPoints=function(lt1_, lt2_, lt3_, lt4_){
				lt1=lt1_;
				lt2=lt2_;
				lt3=lt3_;
				lt4=lt4_;
			};
			svgpl.full=function(){
				var ltcorners=twoD.ltcorners();
				svgpl.setPoints(ltcorners[0], ltcorners[1], ltcorners[2], ltcorners[3]);
			};
			svgpl.none=function(){
				svgpl.setPoints({left:0,top:0},{left:0,top:0},{left:0,top:0},{left:0,top:0});
			};
			svgpl.setHorizonPoints=function(lt1_, lt2_, inPlaneLt){
				var ltlt=twoD.makeInfinite(lt1_, lt2_, null);
				var otherTwo=twoD.completeTheSquare(ltlt[0], ltlt[1], inPlaneLt);
				svgpl.setPoints(ltlt[0], ltlt[1], otherTwo[0], otherTwo[1]);
			
			};
			svgpl.draw=function(){
				svgElement.setAttribute("points", lt1.left+","+lt1.top+" "+lt2.left+","+lt2.top+" "+lt3.left+","+lt3.top+" "+lt4.left+","+lt4.top);
			};
			svgpl.setColor=function(color1){
				svgElement.setAttribute('style', 'fill: '+color1.toString()+';fill-opacity: 0.4');
			};
			return svgpl;
		};
		var SvgSphere=function(color){
			var svgsph={};
			var svgElement=whereSvg.appendChild((function(){
				var NS="http://www.w3.org/2000/svg";
				var polygon=document.createElementNS(NS, 'polygon');
				polygon.setAttribute('points','0,0 0,0 0,0');
				polygon.setAttribute('style','fill: '+color.toString()+'; fill-opacity: 0.4');
				return polygon;
			})());
			var points=[{left:0,top:0},{left:0,top:0},{left:0,top:0}];
			svgsph.setPoints=function(list){
				points=list;
			};
			svgsph.none=function(){svgsph.setPoints([{left:0,top:0},{left:0,top:0},{left:0,top:0}]);};
			svgsph.draw=function(){
				var s="";
				for(i in points){s+=points[i].left+","+points[i].top+" ";}
				svgElement.setAttribute("points", s);
			};
			svgsph.setColor=function(color1){
				svgElement.setAttribute('style', 'fill: '+color1.toString()+';fill-opacity: 0.4');
			};
			return svgsph;
		};
		var addPlane=function(l1, t1, l2, t2, l3, t3, l4, t4, id, index, color){
			var s=SvgPlane(l1, t1, l2, t2, l3, t3, l4, t4, id, color);
			planes[index]=s;
			return s;
		};
		var addSphere=function(color){
			var s=SvgSphere(color);
			spheres.push(s);
			return s;
		};
		var addLightSource=function(color){
			var s=SvgSphere(color);
			lightSources.push(s);
			return s;
		};
		var addLineSegment=function(l1,t1,l2,t2, id, index, color, thickness){
			var s=SvgLine(l1,t1,l2,t2,id,color, thickness);
			lineSegments[index]=s;
			return s;
		};
		var addLineLine=function(l1,t1,l2,t2,id,index,color, thickness){
			var s=SvgLine(l1,t1,l2,t2,id,color, thickness);
			lineLines[index]=s;
			return s;
		};
		var svgObject={};
		var init=function(where_, things_){
			where=where_;
			where.style.backgroundColor=Color(0,0,0).toString();
			var makeAxisAndLabel=function(axisName){
				var NS="http://www.w3.org/2000/svg";
				var line=document.createElementNS(NS,'line');
				line.setAttribute('x1', 0);
				line.setAttribute('y1', 0);
				line.setAttribute('x2', 0);
				line.setAttribute('y2', 0);
				line.setAttribute('style', 'stroke:rgb(100,100,100);stroke-width:0.5');
				//line.setAttribute('id',axisName+'Axis');
				var text=document.createElementNS(NS,'text');
				text.setAttribute('x', 0);
				text.setAttribute('y', 0);
				text.setAttribute('fill', 'rgb(100,100,100)');
				//text.setAttribute('id', axisName+'AxisLabel');
				text.appendChild(document.createTextNode(axisName));
				return {axis:line,label:text};
			};
			whereSvg=(function(){
				var NS="http://www.w3.org/2000/svg";
				var svgNode=document.createElementNS(NS,"svg");
				svgNode.ontouchstart=function(event){onTouchStart(event);};
				svgNode.ontouchmove=function(event){onTouchMove(event);};
				svgNode.ontouchend=function(event){onTouchEnd(event);};
				svgNode.onmousedown=function(event){onMouseDown(event);};
				svgNode.onmouseup=function(event){onMouseUp(event);};
				svgNode.onmousemove=function(event){onMouseMove(event);};
				svgNode.setAttribute('width','100%');
				svgNode.setAttribute('height','100%');
				//svgNode.setAttribute('style', 'border: 1px solid #000000');
				return where.appendChild(svgNode);
			})();

			var axesAndLabels=(function(){
				var svgNode=whereSvg;
				var axesAndLabels=[];

				var al1=makeAxisAndLabel('x');
				axesAndLabels.push({axis:svgNode.appendChild(al1.axis),label:svgNode.appendChild(al1.label)});

				var al2=makeAxisAndLabel('y');
				axesAndLabels.push({axis:svgNode.appendChild(al2.axis),label:svgNode.appendChild(al2.label)});

				var al3=makeAxisAndLabel('z');
				axesAndLabels.push({axis:svgNode.appendChild(al3.axis),label:svgNode.appendChild(al3.label)});

				return axesAndLabels;
			})();

			drawAxes=function(){
				var orlt=viewPort.lt(or);
				if(orlt==null){orlt={left:0,top:0};}
				var u=[xu, yu, zu];
				var lt, i, axis, label, visible;
				for(i=0;i<3;i++){
					visible=viewPort.getVisiblePointsBetween(or, u[i]);
					lt=visible[1];
					if(lt==null){lt=orlt;}
					axis=axesAndLabels[i].axis;
					label=axesAndLabels[i].label;
					axis.setAttribute("x1", orlt.left);
					axis.setAttribute("y1", orlt.top);

					axis.setAttribute("x2", lt.left);
					axis.setAttribute("y2", lt.top);
					
					label.setAttribute("x", lt.left-5);
					label.setAttribute("y", lt.top-5);
				};
			};
			svgObject.drawAxes=drawAxes;

			//BEGIN buttons and such

			var positionString=function(offset){
				return offset?('position:absolute; '+((offset.left||offset.left==0)?'left: '+offset.left+'; ':'right: '+offset.right+'; ')+((offset.top||offset.top==0)?'top: '+offset.top+'; ':'bottom: '+offset.bottom+'; ')):'';
			};
			var sizeString=function(size){
				return size?((size.width?'width: '+size.width+'; ':'')+(size.height?'height: '+size.height+'; ':'')):'';
			};

			var makeButton=function(offset, text, onmousedown, onmouseup, opacity, size){
				var opacityString=opacity?'opacity: '+opacity+'; ':'';
				var button=document.createElement('div');
				button.setAttribute('style', positionString(offset)+'background-color:rgb(50,50,50);color: #FFFFFF;cursor: hand;padding:0px;font-family:Arial; '+opacityString+sizeString(size));
				button.setAttribute('align','center');
				button.onmousedown=function(event){
					preventDefault(event);
					if(event.which!=1){return;}
					
					onmousedown.call(null);
				};
				button.onmouseover=function(){button.style.backgroundColor='rgb(150,150,150)';};
				var stopFunction=function(){
					if(onmouseup){
						onmouseup.call(null);
					}
				};
				button.onmouseup=stopFunction;
				button.onmouseleave=function(){stopFunction();button.style.backgroundColor='rgb(50,50,50)';};
				//button.onmouseup=onmouseup||function(){};
				button.appendChild((function(){
					var a=document.createElement('div');
					a.setAttribute('style','position:relative;top:50%;transform: translateY(-50%);');
					a.appendChild(document.createTextNode(text));
					return a;
				})());
				return button;
			};

			var makeTable=function(nodesInCells, rowHeights){
				var table=document.createElement('table');
				table.setAttribute('style', 'width:100%;height:100%;margin:0px;padding:0px;border-spacing:0px;color:inherit');
				for(var i=0;i<nodesInCells.length;i++){
					var row=document.createElement('tr');
					row.setAttribute('style','margin:0px;padding:0px');
					if(rowHeights){row.setAttribute('height', rowHeights[i]);}
					for(var j=0;j<nodesInCells[i].length;j++){
						var td=document.createElement('td');
						td.setAttribute('style','margin:0px;padding:0px');
						td.appendChild(nodesInCells[i][j]);
						row.appendChild(td);
					}
					table.appendChild(row);
				}
				return table;
			};

			where.appendChild(makeButton({left:0,bottom:0},'XML',function(){xmlDialog.showXml(sceneXml());}, function(){},0.75,{width:'15%',height:'10%'}));
			var xmlDialog=(function(){
				var xmlDialog=document.createElement('div');
				xmlDialog.setAttribute('style', 'position:absolute;left:0;top:0;background-color:rgb(50,50,50);padding:0px;width:40%;height:90%;display:none;opacity:0.75');
				var button=makeButton(null,'OK',function(){xmlDialog.style.display='none';}, function(){}, 1, {width:100,height:50});
				var text=document.createElement('textarea');
				text.setAttribute('style', 'background-color:rgb(50,50,50);color: #FFFFFF;border: none;resize:none;width:100%;height:100%');
				var table=makeTable([[text],[button]],['90%','10%']);
				xmlDialog.appendChild(table);
				where.appendChild(xmlDialog);
				var showXml=function(string){
					var s=string;
					var lines=s.split('<');
					var indent='';
					var minus, equal, line;
					for(var i=1;i<lines.length;i++){
						line=lines[i];
						if(line[0]=='/'){indent=indent.substring(2);}
						lines[i]=indent+'<'+line;
						if(line[0]!='/'&&line.slice(-2)!='/>'){indent=indent+'  ';}
					}
					var s1=lines.join('\n').replace(/^\n/g, '');
					xmlDialog.style.display="initial";
					text.value=s1;
				};
				return {dialog: xmlDialog,text: text,showXml:showXml};
			})();

			var sceneXml=function(){
				var s='<?xml version="1.0" encoding="UTF-8"?><scene xmlns="http://www.sogyo.nl/efokkema_raytrace" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ><group>';
				var planes=PlaneFactory.planes();
				for(var i=0;i<planes.length;i++){
					s+=planes[i].toString();
				}
				var lightSources=SphereFactory.lightSources();
				for(var i=0;i<lightSources.length;i++){
					s+=lightSources[i].toString();
				}
				var spheres=SphereFactory.spheres();
				for(var i=0;i<spheres.length;i++){
					s+=spheres[i].toString();
				}
				return s+'</group>'+viewPort.toString()+'</scene>';
			};

			where.appendChild(makeButton({left:'15%',bottom:0},'shapes', function(){shapeListDialog.showShapeList(sceneShapeList());}, function(){},0.75,{width:'15%',height:'10%'}));
			var shapeListDialog=(function(){
				var shapeListDialog=document.createElement('div');
				var onEdit=function(){};
				var dropDown;
				shapeListDialog.setAttribute('style', 'position:absolute;left:0;top:0;background-color: rgb(50,50,50);padding:0px;width:40%;height:90%;display:none;font-family:Arial;opacity:0.75');
				var button=makeButton(null,'DONE',function(){dropDown.hide();shapeListDialog.style.display='none';onEdit();}, function(){}, 1, {width:100,height:50});
				var button2=makeButton(null,'+',function(){dropDown.show();}, function(){}, 1, {width:100,height:50});
				var text=document.createElement('div');
				text.setAttribute('style','width:100%;height:100%;overflow:scroll;padding:0px;margin:0px');
				var table=makeTable([[text],[makeTable([[button,button2]])]],['90%','10%']);
				shapeListDialog.appendChild(table);
				dropDown=(function(){
					var dropDown=document.createElement('div');
					dropDown.setAttribute('style', 'position:absolute;right:0;bottom:10%;padding:0px;display:none');
					var button1=makeButton(null,'plane',function(){hide();PlaneFactory.makePlane(Point(0,0,0),Point(0,1,0),Color(255,255,255));drawThings();showShapeList(sceneShapeList());}, function(){}, 1, {width:150,height:50});
					var button2=makeButton(null,'sphere',function(){hide();SphereFactory.makeSphere(Point(0,0,0),0.1,Color(255,255,255));drawThings();showShapeList(sceneShapeList());}, function(){}, 1, {width:150,height:50});
					var button3=makeButton(null,'light source',function(){hide();SphereFactory.makeLightSource(Point(0,0,0),0.1,Color(255,255,255));drawThings();showShapeList(sceneShapeList());}, function(){}, 1, {width:150,height:50});
					dropDown.appendChild(makeTable([[button1],[button2],[button3]]));
					shapeListDialog.appendChild(dropDown);
					var hide=function(){dropDown.style.display="none";};
					return {show: function(){dropDown.style.display="initial";},hide:hide};
				})();
				var showShapeList=function(table){
					shapeListDialog.style.display="initial";
					text.innerHTML="";
					text.appendChild(table.table());
					onEdit=function(){
						var onEdits=table.onEdits();
						for(var i=0;i<onEdits.length;i++){
							onEdits[i]();
						}
						drawThings();
					};
				};
				var append=function(thing){
					shapeListDialog.appendChild(thing);
				};
				var remove=function(thing){shapeListDialog.removeChild(thing);};
				where.appendChild(shapeListDialog);
				return {showShapeList: showShapeList, append: append, remove: remove};
			})();

			var sceneShapeList=function(){
				var makeRow={
					"valueBox": function(name, value, edit){
						var box=document.createElement('div');
						box.setAttribute('style','width:50px');
						box.appendChild(document.createTextNode(name+value));
						var isEditable=false;
						var onEdit;
						var editable=makeTable([[document.createTextNode(name),(function(){
							var textbox=document.createElement('input');
							textbox.setAttribute('type','text');
							textbox.setAttribute('style','width:40px');
							textbox.setAttribute('value',value);
							onEdit=function(){edit(parseFloat(textbox.value));};
							return textbox;
						})()]]);
						box.onclick=function(){
							if(!isEditable){
								box.innerHTML='';box.appendChild(editable);isEditable=true;
							}
						};
						return {box:box,onEdit:onEdit};
					},
					"colorBox": function(color,edit){
						var self=this;
						var box=document.createElement('div');
						var currentcolor=color;
						var picker=(function(color_,edit){
							var picker=document.createElement('div');
							picker.setAttribute('style','position: absolute;left:0;top:0;padding:0px;display:none;background-color:rgb(50,50,50);padding:5px;font-family:inherit;color:#FFFFFF');
							var currentcolor=color_;
							var currentr=currentcolor.r();
							var currentg=currentcolor.g();
							var currentb=currentcolor.b();
							var content=(function(){
								var sample=document.createElement('div');
								sample.setAttribute('style','width:40px;height:40px;border: 1pt solid #000000;background-color: '+currentcolor.toString());
								var button=makeButton(null,'OK',function(){
									hide();
									rBox.onEdit();
									gBox.onEdit();
									bBox.onEdit();
									currentcolor=Color(currentr, currentg, currentb);
									sample.style.backgroundColor=currentcolor.toString();
									edit(currentcolor);
								}, function(){}, 1, {width:75,height:30});
								var rBox=self["valueBox"]('r:',currentr,function(r){currentr=r;});
								var gBox=self["valueBox"]('g:',currentg,function(r){currentg=r;});
								var bBox=self["valueBox"]('b:',currentb,function(r){currentb=r;});
								return makeTable([[makeTable([[sample, makeTable([[rBox.box],[gBox.box],[bBox.box]])]])],[button]]);
							})();
							picker.appendChild(content);
							shapeListDialog.append(picker);
							var show=function(){picker.style.display="initial";};
							var hide=function(){picker.style.display="none";};
							var remove=function(){shapeListDialog.remove(picker);}
							return {show:show,remove:remove};
						})(currentcolor, function(color_){box.style.backgroundColor=color_.toString();currentcolor=color_;});
						box.setAttribute('style','border: 1pt solid #000000;cursor: hand;width:40px;height:40px;background-color: '+color.toString());
						box.onclick=function(){picker.show();};
						var onEdit=function(){picker.remove();if(edit){edit(currentcolor);}};
						return {box:box,onEdit:onEdit};
					},
					"pointBox": function(x,y,z,edit){
						var nx=x,ny=y,nz=z;
						var box=document.createElement('div');
						//box.setAttribute('style','border: 1pt solid rgb(150,150,150)');
						var valueBox1=this["valueBox"]('x: ', x, function(v){nx=v;});
						var valueBox2=this["valueBox"]('y: ', y, function(v){ny=v;});
						var valueBox3=this["valueBox"]('z: ', z, function(v){nz=v;});
						var table=makeTable([[valueBox1.box,valueBox2.box,valueBox3.box]]);
						box.appendChild(table);
						var onEdit=function(){valueBox1.onEdit();valueBox2.onEdit();valueBox3.onEdit();if(edit){edit(nx, ny, nz);}};
						return {box:box,onEdit:onEdit};
					},
					"propertyRow": function(name, node){
						var row=document.createElement('div');
						row.setAttribute('style','height:50px;color:inherit');
						var table=makeTable([[document.createTextNode(name),node]]);
						row.appendChild(table);
						return row;
					},
					"rowContainer": function(title, content){
						var row=document.createElement('div');
						row.setAttribute('style','background-color:rgb(75, 75, 75);margin:5px;padding:2px;color:#FFFFFF');
						var titleDiv=document.createElement('div');
						titleDiv.setAttribute('style','font-weight:bold');
						titleDiv.appendChild(document.createTextNode(title));
						row.appendChild(titleDiv);
						var contentDiv=document.createElement('div');
						contentDiv.appendChild(content);
						row.appendChild(contentDiv);
						return row;
					},
					"plane": function(plane){
						var content=document.createElement("div");
						var newpoint=plane.point();
						var newnormal=plane.normal();
						var newcolor=plane.color();
						var pointEditor=this["pointBox"](newpoint.x(), newpoint.y(), newpoint.z(), function(x,y,z){
							newpoint=Point(x,y,z);
						});
						var normalEditor=this["pointBox"](newnormal.x(), newnormal.y(), newnormal.z(), function(x,y,z){
							newnormal=Point(x,y,z);
						});
						var colorEditor=this["colorBox"](newcolor,function(color_){newcolor=color_;});
						content.appendChild(this["propertyRow"]('point: ', pointEditor.box));
						content.appendChild(this["propertyRow"]('normal:', normalEditor.box));
						content.appendChild(this["propertyRow"]('color:', colorEditor.box));
						var onEdit=function(){pointEditor.onEdit();normalEditor.onEdit();colorEditor.onEdit();plane.setPointAndNormal(newpoint, newnormal);plane.setColor(newcolor);};
						return {row: this["rowContainer"]("plane",content),onEdit:onEdit};
					},
					"sphere": function(sphere){
						var content=document.createElement("div");
						var newcenter=sphere.center();
						var newradius=sphere.radius();
						var newcolor=sphere.color();
						var centerEditor=this["pointBox"](newcenter.x(), newcenter.y(), newcenter.z(), function(x,y,z){
							newcenter=Point(x,y,z);
						});
						var radiusEditor=this["valueBox"]('',newradius, function(r){newradius=r;});
						var colorEditor=this["colorBox"](newcolor, function(color_){newcolor=color_;});
						content.appendChild(this["propertyRow"]('center: ', centerEditor.box));
						content.appendChild(this["propertyRow"]('radius: ',radiusEditor.box));
						content.appendChild(this["propertyRow"]('color:', colorEditor.box));
						var onEdit=function(){centerEditor.onEdit();radiusEditor.onEdit();colorEditor.onEdit();sphere.setCenterAndRadius(newcenter, newradius);sphere.setColor(newcolor);};
						return {row: this["rowContainer"]("sphere",content), onEdit:onEdit};
						//return this["rowContainer"]("sphere",content);
					},
					"lightsource": function(lightSource){
						var content=document.createElement("div");
						var newcenter=lightSource.center();
						var newradius=lightSource.radius();
						var newcolor=lightSource.color();
						var centerEditor=this["pointBox"](newcenter.x(), newcenter.y(), newcenter.z(), function(x,y,z){
							newcenter=Point(x,y,z);
						});
						var radiusEditor=this["valueBox"]('',newradius, function(r){newradius=r;});
						var colorEditor=this["colorBox"](newcolor, function(color_){newcolor=color_;});
						content.appendChild(this["propertyRow"]('location: ', centerEditor.box));
						content.appendChild(this["propertyRow"]('radius: ',radiusEditor.box));
						content.appendChild(this["propertyRow"]('color:', colorEditor.box));
						var onEdit=function(){centerEditor.onEdit();radiusEditor.onEdit();colorEditor.onEdit();lightSource.setCenterAndRadius(newcenter, newradius);lightSource.setColor(newcolor);};
						return {row: this["rowContainer"]("light source",content), onEdit:onEdit};
						//return this["rowContainer"]("light source",content);
					}
				};
				var rows=[];
				var onEdits=[];
				var row;
				var lightSources=SphereFactory.lightSources();
				for(var i=0;i<lightSources.length;i++){
					row=makeRow["lightsource"](lightSources[i]);
					onEdits.push(row.onEdit);
					rows.push(row.row);
				}
				var planes=PlaneFactory.planes();
				for(var i=0;i<planes.length;i++){
					row=makeRow["plane"](planes[i]);
					onEdits.push(row.onEdit);
					rows.push(row.row);
				}
				var spheres=SphereFactory.spheres();
				for(var i=0;i<spheres.length;i++){
					row=makeRow["sphere"](spheres[i]);
					onEdits.push(row.onEdit);
					rows.push(row.row);
				}
				var table=document.createElement('div');
				table.setAttribute('style','width:100%;height:100%');
				for(var i=0;i<rows.length;i++){
					table.appendChild(rows[i]);
				}
				return {table: function(){return table;}, onEdits: function(){return onEdits;}};
			};

			where.appendChild(makeButton({left:'30%',bottom:0},'json',function(){jsonDialog.showJson(sceneJson());}, function(){},0.75,{width:'15%',height:'10%'}));
			var jsonDialog=(function(){
				var jsonDialog=document.createElement('div');
				jsonDialog.setAttribute('style', 'position:absolute;left:0;top:0;background-color:rgb(50,50,50);padding:0px;width:40%;height:90%;display:none;opacity:0.75');
				var button=makeButton(null,'OK',function(){jsonDialog.style.display='none';}, function(){}, 1, {width:100,height:50});
				var text=document.createElement('textarea');
				text.setAttribute('style', 'background-color:rgb(50,50,50);color: #FFFFFF;border: none;resize:none;width:100%;height:100%');
				var table=makeTable([[text],[button]],['90%','10%']);
				jsonDialog.appendChild(table);
				where.appendChild(jsonDialog);
				var showJson=function(string){
					var s1=string;
					jsonDialog.style.display="initial";
					text.value=s1;
				};
				return {dialog: jsonDialog,text: text,showJson:showJson};
			})();

			var sceneJson=function(){
				var s=[];
				var planes=PlaneFactory.planes();
				for(var i=0;i<planes.length;i++){
					s.push(planes[i].toString2());
				}
				var lightSources=SphereFactory.lightSources();
				for(var i=0;i<lightSources.length;i++){
					s.push(lightSources[i].toString2());
				}
				var spheres=SphereFactory.spheres();
				for(var i=0;i<spheres.length;i++){
					s.push(spheres[i].toString2());
				}
				return '{viewport: '+viewPort.toString2()+', shapes: ['+s.join(',')+']}';
			};
			
			var newSlideMover=function(move, moveAmountOn){
				var mouseDown=false;
				var currentMoveAmount;
				var doMove=function(){
					if(mouseDown){
						move(currentMoveAmount);
						setTimeout(doMove, 50);
					}
				};
				var setMoveAmount=function(x,y){
					currentMoveAmount=moveAmountOn(x,y);
				};
				return {
					onmousedown: function(x,y){
						setMoveAmount(x,y);
						mouseDown=true;
						doMove();
					},
					onmousemove: function(x,y){
						if(mouseDown){setMoveAmount(x,y);}
					},
					onmouseup: function(){mouseDown=false;}
				};
			};

			var makeSlider=function(offset, size, orientation, slidemover){
				var rectangle=function(offset,size){
					var node=document.createElement('div');
					node.setAttribute('style',positionString(offset)+sizeString(size)+'background-color: rgb(100,100,100);border:1pt solid rgb(200,200,200);border-radius:3px;opacity:0.75');
					return node;
				};
				var barR=1/3;
				var handleR=1/8;
				var whereXy=function(evt){return {x: evt.clientX-where.offsetLeft,y:evt.clientY-where.offsetTop};}
				var slideBar=(function(){
					var thisOffset;
					if(orientation==0){
						thisOffset=offset.left?{left:offset.left}:{right:offset.right};
						if(offset.top){
							thisOffset.top=offset.top+size.height*barR;
						}else{
							thisOffset.bottom=offset.bottom+size.height*barR;
						}
						return rectangle(thisOffset, {width:size.width,height: size.height*barR});
					}else{
						thisOffset=offset.top?{top:offset.top}:{bottom:offset.bottom};
						if(offset.left){
							thisOffset.left=offset.left+size.width*barR;
						}else{
							thisOffset.right=offset.right+size.width*barR;
						}
						return rectangle(thisOffset, {width:size.width*barR,height: size.height});
					}
				})();
				var slideHandle=(function(){
					var thisOffset;
					if(orientation==0){
						thisOffset=offset.top?{top:offset.top}:{bottom:offset.bottom};
						if(offset.left){
							thisOffset.left=offset.left+size.width*(1-handleR)/2;
						}else{
							thisOffset.right=offset.right+size.width*(1-handleR)/2;
						}
					}else{
						thisOffset=offset.left?{left:offset.left}:{right:offset.right};
						if(offset.top){
							thisOffset.top=offset.top+size.height*(1-handleR)/2;
						}else{
							thisOffset.bottom=offset.bottom+size.height*(1-handleR)/2;
						}
					}
					var handle=rectangle(thisOffset,orientation==0?{width:size.width*handleR,height:size.height}:{width:size.width,height:size.height*handleR});
					return handle;
				})();
				var slidePositionHandlers=(function(){
					var mouseDown=false;
					var onMove, onUp;
					var moverXy=(function(){
						if(offset.left||offset.left==0){
							if(offset.top||offset.top==0){
								return function(evt){var xy=whereXy(evt);return {x:xy.x,y:xy.y};}
							}else{
								return function(evt){var xy=whereXy(evt);return {x:xy.x,y:h-xy.y};}
							}
						}else{
							if(offset.top||offset.top==0){
								return function(evt){var xy=whereXy(evt);return {x:w-xy.x,y:xy.y};}
							}else{
								return function(evt){var xy=whereXy(evt);return {x:w-xy.x,y:h-xy.y};}
							}
						}
					})();
					var onMoveAndUp=function(offsetDimension, sizeDimension, direction, smallDisplacement){
						var mindim=offsetDimension;
						var maxdim=offsetDimension+sizeDimension;
						var initdim=offsetDimension+sizeDimension*(1-handleR)/2;
						var onMove=function(evt){
							if(mouseDown){
								preventDefault(evt);
								var mxy=whereXy(evt);
								var xy=moverXy(evt);
								var mouseDim=(direction%2==0)?mxy.x:mxy.y;
								var dimFull=(direction%2==0)?w:h;
								var mouseDim=(direction>1)?dimFull-mouseDim:mouseDim;
								if(slidemover){slidemover.onmousemove(xy.x,xy.y);}
								var newDim=(mouseDim<=mindim)?mindim:((mouseDim>=maxdim)?maxdim:mouseDim-sizeDimension*handleR/2+smallDisplacement);
								switch(direction){
									case 0: slideHandle.style.left=newDim; break;
									case 1: slideHandle.style.top=newDim; break;
									case 2: slideHandle.style.right=newDim; break;
									case 3: slideHandle.style.bottom=newDim; break;
								}
							}
						};
						var onUp=function(){
							switch(direction){
								case 0: slideHandle.style.left=initdim; break;
								case 1: slideHandle.style.top=initdim; break;
								case 2: slideHandle.style.right=initdim; break;
								case 3: slideHandle.style.bottom=initdim; break;
							}
							mouseDown=false;
							if(slidemover){slidemover.onmouseup();}
						};
						return {move:onMove,up:onUp};
					};
					if(orientation==0){
						if(offset.left||offset.left==0){
							var mu=onMoveAndUp(offset.left, size.width, 0, -2);
							onMove=mu.move;
							upUp=mu.up;

						}else{
							var mu=onMoveAndUp(offset.right, size.width, 2, 2);
							onMove=mu.move;
							onUp=mu.up;
						}
					}else{
						if(offset.top||offset.top==0){
							var mu=onMoveAndUp(offset.top, size.height, 1, -2);
							onMove=mu.move;
							onUp=mu.up;
						}else{
							var mu=onMoveAndUp(offset.bottom, size.height, 3, 2);
							onMove=mu.move;
							onUp=mu.up;
						}
					}
					var onDown=function(evt){mouseDown=true;if(slidemover){var xy=moverXy(evt);slidemover.onmousedown(xy.x, xy.y);}};
					return {onDown:onDown,onMove:onMove,onUp:onUp};
				})();
				slideHandle.onmousedown=slidePositionHandlers.onDown;
				slideHandle.onmousemove=slidePositionHandlers.onMove;
				slideHandle.onmouseup=slidePositionHandlers.onUp;
				slideHandle.onmouseleave=slidePositionHandlers.onUp;
				return {bar:slideBar,handle:slideHandle};
			};

			var slider1=makeSlider({right:20,top:20}, {width:10,height:150},1,newSlideMover(function(amount){viewPort.scale(amount);drawThings();}, function(x,y){return 1+(y-95)/500;}));
			where.appendChild(slider1.bar);
			where.appendChild(slider1.handle);

			var slider3=makeSlider({right:40,top:20}, {width:10,height:150},1,newSlideMover(function(amount){viewPort.scale2(amount);drawThings();}, function(x,y){return 1+(y-95)/500;}));
			where.appendChild(slider3.bar);
			where.appendChild(slider3.handle);

			var slider4=makeSlider({right:60,top:20}, {width:10,height:150},1,newSlideMover(function(amount){viewPort.rot2X(amount);drawThings();}, function(x,y){return (y-95)/300;}));
			where.appendChild(slider4.bar);
			where.appendChild(slider4.handle);


			var slider2=makeSlider({right:20,bottom:20}, {width:150,height:10},0,newSlideMover(function(amount){viewPort.rotZ(amount);drawThings();}, function(x,y){return (x-95)/100}));
			where.appendChild(slider2.bar);
			where.appendChild(slider2.handle);

			var slider5=makeSlider({right:20,bottom:40}, {width:150,height:10},0,newSlideMover(function(amount){viewPort.rot2Y(amount);drawThings();}, function(x,y){return (x-95)/300;}));
			where.appendChild(slider5.bar);
			where.appendChild(slider5.handle);

			//END buttons and such

			var currentOnLoad=whereSvg.onload;
			whereSvg.onload=function(){
				if(currentOnLoad){currentOnLoad();}
				(function(){
					if(things_&&things_.shapes&&things_.shapes.length>0){
						console.log("begin adding shapes...");
						for(var i=0;i<things_.shapes.length;i++){
							console.log(things_.shapes[i].type);
							switch(things_.shapes[i].type){
								case "sphere": SphereFactory.makeSphere(Point(things_.shapes[i].center[0], things_.shapes[i].center[1], things_.shapes[i].center[2]),things_.shapes[i].radius, Color(things_.shapes[i].color[0], things_.shapes[i].color[1], things_.shapes[i].color[2])); break;
								case "plane": PlaneFactory.makePlane(Point(things_.shapes[i].point[0],things_.shapes[i].point[1],things_.shapes[i].point[2]), Point(things_.shapes[i].normal[0],things_.shapes[i].normal[1],things_.shapes[i].normal[2]), Color(things_.shapes[i].color[0], things_.shapes[i].color[1], things_.shapes[i].color[2])); break;
								case "lightsource": SphereFactory.makeLightSource(Point(things_.shapes[i].center[0], things_.shapes[i].center[1], things_.shapes[i].center[2]),things_.shapes[i].radius, Color(things_.shapes[i].color[0], things_.shapes[i].color[1], things_.shapes[i].color[2])); break;

							}
						}
						console.log("finish adding shapes");
					}
				})();
				var w_=whereSvg.offsetWidth;
				var h_=whereSvg.offsetHeight;
				svgObject.setWh(w_,h_);
				viewPort.setWh(w_,h_);
				if(things_.viewport){
					(function(){
						var viewport=things_.viewport;
						var lefttop=Point(viewport.lefttop[0], viewport.lefttop[1], viewport.lefttop[2]);
						var leftaxis=Point(viewport.leftaxis[0], viewport.leftaxis[1], viewport.leftaxis[2]);
						var topaxis=Point(viewport.topaxis[0], viewport.topaxis[1], viewport.topaxis[2]);
						var viewpoint=Point(viewport.viewpoint[0], viewport.viewpoint[1], viewport.viewpoint[2]);
						viewPort.setUp(lefttop, leftaxis, topaxis, viewpoint);
					})();
				}
				twoD.setWh(w_,h_);
				drawThings();
			};

		};
		svgObject.setWh=function(w_, h_){w=w_,h=h_;};
		svgObject.addLineSegment=addLineSegment;
		svgObject.addLineLine=addLineLine;
		svgObject.addPlane=addPlane;
		svgObject.addSphere=addSphere;
		svgObject.addLightSource=addLightSource;
		svgObject.init=init;
		return svgObject;
	})();

	var sc={
		init: function(where, things){
			svg.init(where, things);
			delete sc.init;
		}
	};
	return sc;
};


var scene1=new SvgScene();
scene1.init(document.getElementById("viewPort"), {viewport: {lefttop: [1.574768191169261,0.5787247239608981,-0.0281498181267249], leftaxis: [-0.6966716325141249,0.1021206236939497,-1.2292306416218275], topaxis: [0.030051619509980476,-1.0505486652578204,-0.10430816756367789], viewpoint: [2.1870455286857613,0.1841138661860202,-1.2242216432395054]}, shapes: [{type: "plane", point: [0,-0.2,0], normal: [0,1,0], color: [100,75,75]},{type: "plane", point: [0,0,0.25], normal: [0,0,-1], color: [75,75,100]},{type: "lightsource", center: [0,3,0], radius: 1, color: [100,100,50]},{type: "lightsource", center: [0,3,-5], radius: 1, color: [100,100,50]},{type: "sphere", center: [0,0,0], radius: 0.1, color: [0,0,100]},{type: "sphere", center: [0,0.5,0], radius: 0.1, color: [0,0,100]},{type: "sphere", center: [0.5,0,0], radius: 0.1, color: [0,0,100]},{type: "sphere", center: [0.5,0.5,0], radius: 0.1, color: [0,0,100]}]});

// var scene2=new SvgScene();
// scene2.init(document.getElementById("viewPort2"),[
// 	{type: "plane", point: [-2,0,0], normal: [1,0,0], color:[255,0,0]},
// 	{type: "sphere",center: [0,0,0],radius:0.3,color:[0,255,255]}
// ]);



</script>
</body>
</html>